name: Secrets and variables

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Inject secret into core.js
        env:
          BT_KEY: ${{ secrets.BOOTSTRAP_KEY }}
        run: |
          python3 -c "
          import os
          key = os.environ['BT_KEY']
          with open('js/core.js', 'r') as f: content = f.read()
          content = content.replace('__BOOTSTRAP_KEY__', key)
          with open('js/core.js', 'w') as f: f.write(content)
          "

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Minify and bundle
        run: |
          npm install -g terser clean-css-cli

          # Bundle all JS files in load order (after secrets injection)
          cat js/core.js js/ui.js js/grids.js js/forms.js js/analytics.js > js/bundle.js
          terser js/bundle.js -o js/bundle.min.js --compress --mangle
          rm js/bundle.js

          # Minify CSS
          cleancss -o styles.min.css styles.css

          # Update index.html to use minified assets
          sed -i 's|href="/styles.css"|href="/styles.min.css"|' index.html
          sed -i '/<script src="\/js\/core.js"><\/script>/,/<script src="\/js\/analytics.js"><\/script>/c\<script src="/js/bundle.min.js"></script>' index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          force_orphan: true