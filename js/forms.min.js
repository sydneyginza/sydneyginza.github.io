const formOverlay=document.getElementById("formOverlay"),formFields=["fName","fAge","fBody","fHeight","fCup","fVal1","fVal2","fVal3","fSpecial","fExp","fStartDate","fLang","fType","fDesc"];let formLabels=[];document.getElementById("formClose").onclick=()=>formOverlay.classList.remove("open"),document.getElementById("formCancel").onclick=()=>formOverlay.classList.remove("open"),formOverlay.onclick=n=>{n.target===formOverlay&&formOverlay.classList.remove("open")};let formPhotos=[],formPhotosToDelete=[],formNewPhotos=[],formNewFiles=[],formCountries=[],selectedPhotoIdx=null;const COUNTRY_OPTIONS=["Chinese","French","Italian","Japanese","Korean","Russian","Thailand","Vietnamese","Other"];function renderFormCountries(){const n=document.getElementById("fCountryOptions");n.innerHTML="",COUNTRY_OPTIONS.forEach(e=>{const o=document.createElement("div");o.className="country-opt"+(formCountries.includes(e)?" selected":""),o.textContent=e,o.onclick=()=>{formCountries.includes(e)?formCountries=formCountries.filter(a=>a!==e):formCountries.push(e),renderFormCountries()},n.appendChild(o)})}function renderFormPhotos(){const n=document.getElementById("fPhotoGrid"),e=document.getElementById("fPhotoCount");if(n.innerHTML="",e.textContent=`(${formPhotos.length} / ${MAX_PHOTOS})`,formPhotos.length>1){const a=document.createElement("div");a.style.cssText='width:100%;font-family:"Rajdhani",sans-serif;font-size:11px;color:rgba(255,255,255,0.25);letter-spacing:1px;margin-bottom:6px',a.textContent="Click to select · ← → to move · Drag to reorder",n.appendChild(a)}let o=null;if(formPhotos.forEach((a,i)=>{const l=document.createElement("div");l.style.cssText="position:relative;display:inline-block;cursor:grab",l.draggable=!0;const d=document.createElement("div");d.style.cssText="width:64px;height:64px;border:2px solid rgba(255,255,255,0.1);overflow:hidden;clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,6px 100%,0 calc(100% - 6px));transition:border-color .15s",selectedPhotoIdx===i&&(d.style.borderColor="var(--accent)"),d.innerHTML=`<img src="${a}" style="width:100%;height:100%;object-fit:cover;pointer-events:none">`,l.onclick=s=>{s.target===f||f.contains(s.target)||(selectedPhotoIdx=selectedPhotoIdx===i?null:i,renderFormPhotos())};const f=document.createElement("button");f.style.cssText="position:absolute;top:1px;right:1px;width:18px;height:18px;background:rgba(0,0,0,0.85);border:1px solid rgba(255,68,68,0.5);color:#ff4444;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:2px;z-index:2",f.innerHTML="&#x2715;",f.onclick=s=>{s.stopPropagation(),selectedPhotoIdx===i?selectedPhotoIdx=null:selectedPhotoIdx>i&&selectedPhotoIdx--;const r=formPhotos[i];if(r.startsWith("data:")){const c=formNewPhotos.indexOf(r);c>=0&&(formNewPhotos.splice(c,1),formNewFiles.splice(c,1))}formPhotosToDelete.push(r),formPhotos.splice(i,1),renderFormPhotos()},l.ondragstart=s=>{o=i,s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/plain",String(i)),setTimeout(()=>{l.style.opacity="0.35"},0)},l.ondragend=()=>{l.style.opacity="",o=null,n.querySelectorAll("div[draggable]").forEach(s=>{const r=s.querySelector("div");r&&(r.style.borderColor="rgba(255,255,255,0.1)")})},l.ondragover=s=>{s.preventDefault(),s.dataTransfer.dropEffect="move",o!==null&&o!==i&&(d.style.borderColor="var(--accent)")},l.ondragleave=()=>{d.style.borderColor="rgba(255,255,255,0.1)"},l.ondrop=s=>{s.preventDefault(),d.style.borderColor="rgba(255,255,255,0.1)";const r=parseInt(s.dataTransfer.getData("text/plain")),c=i;if(r===c||isNaN(r))return;const u=formPhotos.splice(r,1)[0];formPhotos.splice(c,0,u),renderFormPhotos()},l.appendChild(d),l.appendChild(f),n.appendChild(l)}),formPhotos.length<MAX_PHOTOS){const a=document.createElement("div");a.style.cssText="width:64px;height:64px;border:2px dashed rgba(180,74,255,0.3);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--accent);font-size:22px;clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,6px 100%,0 calc(100% - 6px));transition:all .3s",a.innerHTML="+",a.onmouseenter=()=>{a.style.borderColor="var(--accent)",a.style.background="rgba(180,74,255,0.06)"},a.onmouseleave=()=>{a.style.borderColor="rgba(180,74,255,0.3)",a.style.background="none"},a.onclick=()=>{const i=MAX_PHOTOS-formPhotos.length;if(i<=0)return;const l=document.createElement("input");l.type="file",l.accept="image/*",l.multiple=!0,l.onchange=d=>{const f=Array.from(d.target.files).slice(0,i);let s=0;f.forEach(r=>{const c=new FileReader;c.onload=u=>{formPhotos.push(u.target.result),formNewPhotos.push(u.target.result),formNewFiles.push(r.name),s++,s===f.length&&renderFormPhotos()},c.readAsDataURL(r)})},l.click()},n.appendChild(a)}}function renderFormLabels(){const n=document.getElementById("fLabelTags");n.innerHTML="",formLabels.forEach((e,o)=>{const a=document.createElement("span");a.className="label-tag",a.innerHTML=`${e}<button class="label-remove" title="Remove">&times;</button>`,a.querySelector(".label-remove").onclick=()=>{formLabels.splice(o,1),renderFormLabels()},n.appendChild(a)})}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("fLabelInput");n&&n.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();const o=sanitize(n.value);o&&!formLabels.includes(o)&&(formLabels.push(o),renderFormLabels()),n.value=""}}),document.addEventListener("keydown",e=>{if(formOverlay.classList.contains("open")&&selectedPhotoIdx!==null&&!(document.activeElement&&document.activeElement.matches("input,textarea,select"))){if(e.key==="ArrowLeft"&&selectedPhotoIdx>0){e.preventDefault();const o=formPhotos.splice(selectedPhotoIdx,1)[0];selectedPhotoIdx--,formPhotos.splice(selectedPhotoIdx,0,o),renderFormPhotos()}else if(e.key==="ArrowRight"&&selectedPhotoIdx<formPhotos.length-1){e.preventDefault();const o=formPhotos.splice(selectedPhotoIdx,1)[0];selectedPhotoIdx++,formPhotos.splice(selectedPhotoIdx,0,o),renderFormPhotos()}}})});function sanitize(n){return(n||"").replace(/<[^>]+>/g,"").trim()}function openForm(n=-1){if(document.getElementById("editIndex").value=n,formPhotosToDelete=[],formNewPhotos=[],formNewFiles=[],selectedPhotoIdx=null,n>=0){document.getElementById("formTitle").textContent=t("form.editGirl");const e=girls[n];document.getElementById("fName").value=e.name;const o=e.country||"";formCountries=Array.isArray(o)?[...o]:o?[o]:[],document.getElementById("fAge").value=e.age,document.getElementById("fBody").value=e.body,document.getElementById("fHeight").value=e.height,document.getElementById("fCup").value=e.cup,document.getElementById("fVal1").value=e.val1||"",document.getElementById("fVal2").value=e.val2||"",document.getElementById("fVal3").value=e.val3||"",document.getElementById("fSpecial").value=e.special||"",document.getElementById("fExp").value=e.exp||"",document.getElementById("fStartDate").value=e.startDate||fmtDate(getAEDTDate()),document.getElementById("fLang").value=e.lang||"",document.getElementById("fType").value=e.type||"",document.getElementById("fDesc").value=e.desc,formPhotos=[...e.photos||[]],formLabels=[...e.labels||[]]}else document.getElementById("formTitle").textContent=t("form.addGirl"),formFields.forEach(e=>document.getElementById(e).value=""),document.getElementById("fStartDate").value=fmtDate(getAEDTDate()),formPhotos=[],formLabels=[],formCountries=[];renderFormPhotos(),renderFormLabels(),renderFormCountries(),formOverlay.classList.add("open")}document.getElementById("formSave").onclick=async()=>{const n=[{id:"fName",label:"Name"},{id:"fAge",label:"Age"},{id:"fBody",label:"Body Size"},{id:"fHeight",label:"Height"},{id:"fCup",label:"Cup Size"},{id:"fExp",label:"Experience"},{id:"fVal3",label:"Value 3"},{id:"fStartDate",label:"Start Date"},{id:"fLang",label:"Language"},{id:"fType",label:"Type"},{id:"fDesc",label:"Description"}];for(const a of n){const i=document.getElementById(a.id);if(!i.value.trim()){i.focus(),showToast(a.label+" is required","error");return}}if(formCountries.length===0){showToast("Country is required","error");return}if(formPhotos.length===0){showToast("At least one photo is required","error");return}const e=sanitize(document.getElementById("fName").value),o=document.getElementById("formSave");o.textContent="SAVING...",o.style.pointerEvents="none";try{for(const c of formPhotosToDelete)c.includes("githubusercontent.com")&&await deleteFromGithub(c);const a=[];for(const c of formPhotos)if(c.startsWith("data:"))if(GT){const u=formNewPhotos.indexOf(c);a.push(await uploadToGithub(c,e,u>=0?formNewFiles[u]:genFn()))}else a.push(c);else a.push(c);const i=document.getElementById("fSpecial").value.trim(),l=document.getElementById("fLang").value.trim(),d=document.getElementById("fType").value.trim(),f=sanitize(document.getElementById("fDesc").value),s={name:e,location:"Empire",country:[...formCountries],age:document.getElementById("fAge").value.trim(),body:document.getElementById("fBody").value.trim(),height:document.getElementById("fHeight").value.trim(),cup:document.getElementById("fCup").value.trim(),val1:document.getElementById("fVal1").value.trim(),val2:document.getElementById("fVal2").value.trim(),val3:document.getElementById("fVal3").value.trim(),special:i,exp:document.getElementById("fExp").value.trim(),startDate:document.getElementById("fStartDate").value.trim(),lang:l,type:d,desc:f,specialJa:i,langJa:l,typeJa:d,descJa:f,photos:a,labels:[...formLabels],labelsJa:[...formLabels],lastModified:new Date().toISOString()},r=parseInt(document.getElementById("editIndex").value);r>=0?girls[r]=s:girls.push(s),await saveData()&&(logAdminAction(r>=0?"profile_edit":"profile_add",e),formOverlay.classList.remove("open"),renderFilters(),renderGrid(),renderRoster(),renderHome(),document.getElementById("profilePage").classList.contains("active")&&r>=0&&showProfile(r),showToast(r>=0?"Profile updated":"Profile added"))}catch(a){showToast("Error: "+a.message,"error")}finally{o.textContent="SAVE",o.style.pointerEvents="auto"}};const deleteOverlay=document.getElementById("deleteOverlay");document.getElementById("deleteCancel").onclick=()=>deleteOverlay.classList.remove("open"),deleteOverlay.onclick=n=>{n.target===deleteOverlay&&deleteOverlay.classList.remove("open")};function openDelete(n){deleteTarget=n,document.getElementById("deleteMsg").textContent=`Remove "${girls[n].name}" from the roster?`,deleteOverlay.classList.add("open")}document.getElementById("deleteConfirm").onclick=async()=>{if(deleteTarget>=0){const n=girls[deleteTarget];if(n.photos&&GT)for(const o of n.photos)o.includes("githubusercontent.com")&&await deleteFromGithub(o);const e=n.name;girls.splice(deleteTarget,1),await saveData(),logAdminAction("profile_delete",e),deleteTarget=-1,deleteOverlay.classList.remove("open"),renderFilters(),renderGrid(),renderRoster(),renderHome(),document.getElementById("profilePage").classList.contains("active")&&showPage("homePage"),showToast("Profile deleted")}};function removeSkeletons(){["homeSkeleton","rosterSkeleton","girlsSkeleton","calSkeleton","rosterFilterSkeleton","girlsFilterSkeleton","favoritesSkeleton","valueTableSkeleton"].forEach(e=>{const o=document.getElementById(e);o&&(o.classList.add("fade-out"),setTimeout(()=>o.remove(),400))})}function normalizeCalData(n){if(!n)return{};for(const e in n)for(const o in n[e])n[e][o]===!0&&(n[e][o]={start:"",end:""});return n}function fullRender(){rosterDateFilter=fmtDate(getAEDTDate()),renderFilters(),renderGrid(),renderRoster(),renderHome(),updateFavBadge()}let _refreshTick=0;setInterval(async()=>{if(_refreshTick++,_refreshTick%5===0)try{const n=calSha,e=await loadCalData();if(calSha&&calSha!==n){calData=normalizeCalData(e),updateCalCache();const o=document.querySelector(".page.active");if(o){const a=o.id;a==="rosterPage"?renderRoster():a==="listPage"?renderGrid():a==="favoritesPage"?renderFavoritesGrid():a==="homePage"?renderHome():a==="profilePage"&&currentProfileIdx>=0&&showProfile(currentProfileIdx)}}}catch{}try{const n=document.querySelector(".page.active");if(!n)return;const e=n.id;e==="rosterPage"?renderRoster():e==="listPage"?renderGrid():e==="favoritesPage"?renderFavoritesGrid():e==="homePage"?renderHome():e==="profilePage"&&currentProfileIdx>=0&&showProfile(currentProfileIdx)}catch{}},6e4);function fullRenderAndRoute(){typeof queryToFilters=="function"&&queryToFilters(),fullRender(),window.location.pathname!=="/"?Router.resolve():history.replaceState({path:"/"},"Ginza Empire","/")}async function initApp(){try{await loadConfig(),typeof initOfflineDetection=="function"&&initOfflineDetection();const n=getCachedGirls(),e=getCachedCal();let o=!1,a=!1;if(n&&n.length){girls=n;const r=!isCalCacheStale();calData=r&&e?normalizeCalData(e):{},a=!r,fullRenderAndRoute(),removeSkeletons(),o=!0}const[i,l,d]=await Promise.all([loadAuth(),loadData(),loadCalData(),loadRosterHistory()]);i&&i.length?CRED=i:(CRED=[],showToast("Could not load auth","error"));let f=!1;if(l!==null){const r=getCachedGirlsSha();(!o||r!==dataSha)&&(girls=l,f=!0,updateGirlsCache())}else if(!o){const r=typeof t=="function"?t("ui.loadFailed"):"Unable to load data. Please check your connection and try again.";showErrorState("rosterGrid",r,initApp),showErrorState("girlsGrid",r,initApp),showErrorState("homeImages",r,initApp),removeSkeletons();return}let s=!1;if(d){const r=getCachedCalSha(),c=normalizeCalData(d);(!o||r!==calSha||a)&&(calData=c,s=!0,updateCalCache())}if(o?(f||s)&&(fullRender(),document.getElementById("profilePage").classList.contains("active")&&showProfile(currentProfileIdx)):(fullRenderAndRoute(),removeSkeletons()),typeof applyLang=="function")try{applyLang()}catch{}}catch(n){console.error("Init error:",n),removeSkeletons();const e=typeof t=="function"?t("ui.loadFailed"):"Unable to load data. Please check your connection and try again.";showErrorState("rosterGrid",e,initApp),showErrorState("girlsGrid",e,initApp),showErrorState("homeImages",e,initApp)}}initApp();
