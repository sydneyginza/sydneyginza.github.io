const VisitorLog=function(){const r="ginza_visitor_uuid",l="ginza_analytics_optout",g="data/logs";let p=[],m=null,v=!1,i=null;const P=2e3;function z(){try{let a=localStorage.getItem(r);return a||(a="v_"+Date.now().toString(36)+"_"+Math.random().toString(36).substr(2,8),localStorage.setItem(r,a)),a}catch{return"v_anon_"+Math.random().toString(36).substr(2,8)}}function O(){try{return localStorage.getItem(l)==="1"}catch{return!1}}function At(){try{localStorage.setItem(l,"1"),localStorage.removeItem(r),localStorage.removeItem("ginza_log_pending"),p=[]}catch{}}function qt(){try{localStorage.removeItem(l)}catch{}}function St(){const a=navigator.userAgent||"";let f="Desktop",d="Unknown",h="Unknown";return/Windows/i.test(a)?h="Windows":/Macintosh|Mac OS/i.test(a)?h="macOS":/Android/i.test(a)?(h="Android",f="Mobile"):/iPhone/i.test(a)?(h="iOS",f="Mobile"):/iPad/i.test(a)?(h="iOS",f="Tablet"):/Linux/i.test(a)?h="Linux":/CrOS/i.test(a)&&(h="ChromeOS"),/Edg\//i.test(a)?d="Edge":/OPR\//i.test(a)||/Opera/i.test(a)?d="Opera":/SamsungBrowser/i.test(a)?d="Samsung":/Chrome/i.test(a)?d="Chrome":/Safari/i.test(a)&&!/Chrome/i.test(a)?d="Safari":/Firefox/i.test(a)&&(d="Firefox"),{ua:a,browser:d,os:h,device:f}}const X=St(),H=z();function Lt(){return{type:"session",uuid:H,timestamp:new Date().toISOString(),userAgent:X.ua,browser:X.browser,os:X.os,device:X.device,language:navigator.language||navigator.userLanguage||"unknown",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"unknown",tzOffset:new Date().getTimezoneOffset(),page:window.location.pathname+window.location.search,referrer:document.referrer||"direct",screen:window.screen?window.screen.width+"x"+window.screen.height:"unknown",viewport:window.innerWidth+"x"+window.innerHeight,siteLang:function(){try{return localStorage.getItem("ginza_lang")||"en"}catch{return"en"}}()}}function dt(a){return{type:"pageView",uuid:H,timestamp:new Date().toISOString(),page:a}}function _t(a){return{type:"profileView",uuid:H,timestamp:new Date().toISOString(),profile:a}}function N(a){return{type:"filterUse",uuid:H,timestamp:new Date().toISOString(),active:a}}function ct(a){return{type:"phoneTap",uuid:H,timestamp:new Date().toISOString(),number:a}}function Z(a){p.push(a),clearTimeout(m),m=setTimeout(()=>tt(),P)}function W(a){!a||O()||Z(dt(a))}function Dt(a){!a||O()||Z(_t(a))}let ft=null;function kt(a){O()||!a||!a.length||(clearTimeout(ft),ft=setTimeout(()=>Z(N(a)),3e3))}function Y(a){O()||Z(ct(a||"unknown"))}function Q(){const a=new Date(new Date().toLocaleString("en-US",{timeZone:"Australia/Sydney"})),f=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0");return`${g}/${f}.json`}async function tt(){if(p.length===0)return;if(v)return i&&await i,p.length>0?tt():void 0;v=!0;const a=[...p];p=[];const f=Q();return i=(async()=>{try{let d=[],h=null;const $=await fetchWithRetry(`${DATA_API}/${f}`,{headers:proxyHeaders()},{retries:1,baseDelay:500});if($.ok){const y=await $.json();h=y.sha;try{d=JSON.parse(decodeURIComponent(escape(atob(y.content.replace(/\n/g,"")))))}catch{d=[]}}d.length+a.length>500&&(d=d.slice(d.length+a.length-500)),d.push(...a);const D={message:"Log "+a.length+" entries",content:btoa(unescape(encodeURIComponent(JSON.stringify(d,null,2))))};h&&(D.sha=h);const T=await fetchWithRetry(`${DATA_API}/${f}`,{method:"PUT",headers:proxyHeaders(),body:JSON.stringify(D)},{retries:1,baseDelay:500});T.ok||(p.unshift(...a),console.warn("Visitor log write failed:",T.status))}catch(d){p.unshift(...a),console.warn("Visitor log flush failed:",d.message)}finally{v=!1,i=null}})(),i}function et(){if(p.length===0)return;const a=[...p];p=[];try{const f=Q(),d="ginza_log_pending";let h=[];try{const $=localStorage.getItem(d);$&&(h=JSON.parse($))}catch{}h.push(...a),localStorage.setItem(d,JSON.stringify(h))}catch{}}async function Pt(){const a="ginza_log_pending";try{const f=localStorage.getItem(a);if(!f)return;const d=JSON.parse(f);if(!d.length)return;localStorage.removeItem(a),p.unshift(...d),await tt()}catch{}}async function nt(a,f){const d=[];try{const h=await fetchWithRetry(`${DATA_API}/${g}`,{headers:proxyHeaders()},{retries:1,baseDelay:500});if(!h.ok)return d;const $=await h.json();if(!Array.isArray($))return d;const D=$.filter(y=>{const q=y.name.match(/^(\d{4}-\d{2}-\d{2})\.json$/);if(!q)return!1;const U=q[1];return U>=a&&U<=f}),T=[];for(let y=0;y<D.length;y+=10)T.push(D.slice(y,y+10));for(const y of T)(await Promise.all(y.map(async U=>{try{const _=await fetchWithRetry(`${DATA_API}/${g}/${U.name}`,{headers:proxyHeaders()},{retries:1,baseDelay:300});if(!_.ok)return[];const k=await _.json();return JSON.parse(decodeURIComponent(escape(atob(k.content.replace(/\n/g,"")))))}catch{return[]}}))).forEach(U=>d.push(...U))}catch(h){console.warn("Failed to load visitor logs:",h.message)}return d}function Et(a){const f=new Set,d={},h={},$={},D={},T={},y={},q={},U={},_={},k={},ht={},I={},G={},at={},J={},j={},gt={},V={},st={},L={},mt={},F={},pt={},K={};let it=0;const M={},Ut=new Set;let e=0,n=0,o=0,c=0;for(let s=0;s<24;s++)j[String(s).padStart(2,"0")]=0;a.forEach(s=>{const S=s.uuid||"unknown";if(s.type==="session"||!s.type){n++,f.add(S);const u=s.browser||vt(s.userAgent);d[u]=(d[u]||0)+1,h[u]||(h[u]=new Set),h[u].add(S);const C=s.os||ut(s.userAgent);$[C]=($[C]||0)+1,D[C]||(D[C]=new Set),D[C].add(S);const A=s.device||"Unknown";T[A]=(T[A]||0)+1,y[A]||(y[A]=new Set),y[A].add(S);const wt=(s.language||"unknown").split("-")[0];if(q[wt]=(q[wt]||0)+1,U[wt]||(U[wt]=new Set),U[wt].add(S),s.siteLang){const E=s.siteLang;_[E]=(_[E]||0)+1,k[E]||(k[E]=new Set),k[E].add(S)}const $t=s.timezone||"unknown";ht[$t]=(ht[$t]||0)+1,I[$t]||(I[$t]=new Set),I[$t].add(S);let lt="direct";if(s.referrer&&s.referrer!=="direct")try{lt=new URL(s.referrer).hostname}catch{lt=s.referrer}if(G[lt]=(G[lt]||0)+1,at[lt]||(at[lt]=new Set),at[lt].add(S),s.screen&&s.screen!=="unknown"&&(J[s.screen]=(J[s.screen]||0)+1),s.page){const E=s.page;st[E]=(st[E]||0)+1,L[E]||(L[E]=new Set),L[E].add(S),o++}}if(s.type==="pageView"){const u=s.page||"unknown";st[u]=(st[u]||0)+1,L[u]||(L[u]=new Set),L[u].add(S),o++,f.add(S)}if(s.type==="profileView"){const u=s.profile||"unknown";mt[u]=(mt[u]||0)+1,F[u]||(F[u]=new Set),F[u].add(S),c++,f.add(S)}if(s.type==="filterUse"&&(it++,(s.active||[]).forEach(u=>{pt[u]=(pt[u]||0)+1,K[u]||(K[u]=new Set),K[u].add(S)}),f.add(S)),s.type==="phoneTap"){e++,Ut.add(S);const u=s.number||"unknown";M[u]=(M[u]||0)+1,f.add(S)}if(s.timestamp)try{const C=new Date(s.timestamp).toLocaleString("en-US",{timeZone:"Australia/Sydney",hour:"2-digit",hour12:!1}),A=String(parseInt(C)).padStart(2,"0");j[A]=(j[A]||0)+1}catch{}if(s.timestamp)try{const u=new Date(s.timestamp),C=new Date(u.toLocaleString("en-US",{timeZone:"Australia/Sydney"})),A=C.getFullYear()+"-"+String(C.getMonth()+1).padStart(2,"0")+"-"+String(C.getDate()).padStart(2,"0");gt[A]=(gt[A]||0)+1,V[A]||(V[A]=new Set),V[A].add(S)}catch{}});const b={};for(const s in V)b[s]=V[s].size;const w={};for(const s in L)w[s]=L[s].size;const R={};for(const s in F)R[s]=F[s].size;const x={};for(const s in h)x[s]=h[s].size;const ot={};for(const s in D)ot[s]=D[s].size;const B={};for(const s in y)B[s]=y[s].size;const bt={};for(const s in U)bt[s]=U[s].size;const yt={};for(const s in k)yt[s]=k[s].size;const Tt={};for(const s in I)Tt[s]=I[s].size;const xt={};for(const s in at)xt[s]=at[s].size;const Ct={};for(const s in K)Ct[s]=K[s].size;return{totalHits:n,totalPageViews:o,totalProfileViews:c,totalPhoneTaps:e,phoneTapUnique:Ut.size,phoneTapsByNumber:M,totalFilterUses:it,filterDimensions:pt,filterDimensionsUniqueCounts:Ct,uniqueVisitors:f.size,browsers:d,oses:$,devices:T,languages:q,siteLanguages:_,timezones:ht,referrers:G,screens:J,browsersUniqueCounts:x,osesUniqueCounts:ot,devicesUniqueCounts:B,languagesUniqueCounts:bt,siteLanguagesUniqueCounts:yt,timezonesUniqueCounts:Tt,referrersUniqueCounts:xt,hourly:j,daily:gt,dailyUniqueCounts:b,pageViewsTotal:st,pageViewsUniqueCounts:w,profileViewsTotal:mt,profileViewsUniqueCounts:R}}function vt(a){return a?/Edg\//i.test(a)?"Edge":/OPR\//i.test(a)?"Opera":/SamsungBrowser/i.test(a)?"Samsung":/Chrome/i.test(a)?"Chrome":/Safari/i.test(a)&&!/Chrome/i.test(a)?"Safari":/Firefox/i.test(a)?"Firefox":"Other":"Unknown"}function ut(a){return a?/Windows/i.test(a)?"Windows":/Macintosh/i.test(a)?"macOS":/Android/i.test(a)?"Android":/iPhone|iPad/i.test(a)?"iOS":/Linux/i.test(a)?"Linux":"Other":"Unknown"}return O()||(Z(Lt()),Pt().then(()=>tt())),window.addEventListener("beforeunload",()=>{p.length!==0&&et()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&p.length>0&&et()}),{trackPageView:W,trackProfileView:Dt,trackFilterUse:kt,trackPhoneTap:Y,flush:tt,loadLogs:nt,aggregateLogs:Et,getUUID:z,isOptedOut:O,optOut:At,optIn:qt}}();let analyticsPeriod=7,cachedVisitorData=null,cachedVisitorPeriod=null;function renderAnalytics(){const r=document.getElementById("analyticsContent");r&&(renderVisitorAnalytics(r),renderAdminLog())}function _todayStr(){const r=new Date;return r.getFullYear()+"-"+String(r.getMonth()+1).padStart(2,"0")+"-"+String(r.getDate()).padStart(2,"0")}async function renderVisitorAnalytics(r){const l=[{d:1,l:t("ui.today")},{d:7,l:"7"+t("an.days")},{d:14,l:"14"+t("an.days")},{d:30,l:"30"+t("an.days")},{d:90,l:"90"+t("an.days")}];let g='<div class="an-period">';l.forEach(e=>{g+=`<button class="an-period-btn${analyticsPeriod===e.d?" active":""}" data-days="${e.d}">${e.l}</button>`}),g+="</div>",r.innerHTML=g+'<div class="an-loading"><div class="an-loading-spinner"></div><div class="an-loading-text">'+t("an.loading")+"</div></div>",r.querySelectorAll(".an-period-btn").forEach(e=>{e.onclick=()=>{analyticsPeriod=parseInt(e.dataset.days),cachedVisitorData=null,renderAnalytics()}});const rt=_todayStr(),p=new Date(new Date().toLocaleString("en-US",{timeZone:"Australia/Sydney"}));p.setDate(p.getDate()-analyticsPeriod);const m=p.getFullYear()+"-"+String(p.getMonth()+1).padStart(2,"0")+"-"+String(p.getDate()).padStart(2,"0");let v;cachedVisitorData&&cachedVisitorPeriod===analyticsPeriod?v=cachedVisitorData:(v=await VisitorLog.loadLogs(m,rt),cachedVisitorData=v,cachedVisitorPeriod=analyticsPeriod);const i=VisitorLog.aggregateLogs(v),P=Array.from({length:7},()=>Array(24).fill(0));v.forEach(e=>{if(e.timestamp)try{const n=new Date(e.timestamp),o=parseInt(n.toLocaleString("en-US",{timeZone:"Australia/Sydney",hour:"2-digit",hour12:!1})),c=n.toLocaleString("en-US",{timeZone:"Australia/Sydney",year:"numeric",month:"2-digit",day:"2-digit"}),[b,w,R]=c.split("/"),x=new Date(R+"-"+b+"-"+w+"T00:00:00").getDay();o>=0&&o<24&&x>=0&&x<7&&P[x][o]++}catch{}});const z=Object.keys(i.daily).length,O=z>0?Math.round(i.totalHits/z):0,At=z>0?Math.round(i.uniqueVisitors/z):0,qt=`<div class="an-summary">
<div class="an-card"><div class="an-card-val">${i.uniqueVisitors}</div><div class="an-card-label">${t("an.uniqueVisitors")}</div></div>
<div class="an-card"><div class="an-card-val">${i.totalHits}</div><div class="an-card-label">${t("an.sessions")}</div></div>
<div class="an-card"><div class="an-card-val">${i.totalPageViews}</div><div class="an-card-label">${t("an.totalPageViews")}</div></div>
<div class="an-card"><div class="an-card-val">${i.totalProfileViews}</div><div class="an-card-label">${t("an.totalProfileViews")}</div></div>
<div class="an-card"><div class="an-card-val">${i.totalPhoneTaps}</div><div class="an-card-label">${t("an.phoneTaps")}</div></div>
<div class="an-card"><div class="an-card-val">${i.totalFilterUses}</div><div class="an-card-label">${t("an.filterUses")}</div></div>
</div>`,St=Object.entries(i.profileViewsTotal).sort((e,n)=>n[1]-e[1]).slice(0,5),X=["#1","#2","#3","#4","#5"];let H=`<div class="an-section"><div class="an-section-title">${t("an.topProfiles")} <span class="an-hint">${t("an.topHint")}</span></div><div class="an-top5">`;for(let e=0;e<5;e++){const n="an-rank-"+(e+1);if(e<St.length){const[o,c]=St[e],b=i.profileViewsUniqueCounts[o]||0,w=typeof girls<"u"?girls.find(B=>B&&B.name===o):null,R=w&&w.photos&&w.photos.length?`<img class="an-top5-photo" src="${w.photos[0]}" alt="${o.replace(/"/g,"&quot;")}">`:'<div class="an-top5-photo-empty"></div>',ot=w&&typeof isAvailableNow=="function"&&isAvailableNow(w.name)?'<span class="avail-now-dot" title="Available now" style="display:inline-block;margin-left:4px"></span>':"";H+=`<div class="an-top5-card"><div class="an-top5-rank ${n}">${X[e]}</div>${R}<div class="an-top5-name">${o}${ot}</div><span class="an-top5-total">${c}</span><div class="an-top5-unique">${t("an.uniqueCount").replace("{n}",b)}</div></div>`}else H+=`<div class="an-top5-card"><div class="an-top5-rank ${n}">${X[e]}</div><div class="an-top5-photo-empty"></div><div class="an-top5-empty">â€”</div></div>`}H+="</div></div>";const Lt=i.uniqueVisitors>0?(i.phoneTapUnique/i.uniqueVisitors*100).toFixed(1):"0.0",dt=Object.entries(i.phoneTapsByNumber).sort((e,n)=>n[1]-e[1]),_t=dt.length?dt[0][1]:1;let N=`<div class="an-section"><div class="an-section-title">${t("an.conversion")} <span class="an-hint">${t("an.conversionHint")}</span></div>`;N+=`<div class="an-summary" style="margin-bottom:16px"><div class="an-card"><div class="an-card-val">${i.totalPhoneTaps}</div><div class="an-card-label">${t("an.phoneTaps")}</div></div><div class="an-card"><div class="an-card-val">${i.phoneTapUnique}</div><div class="an-card-label">${t("an.uniqueTappers")}</div></div><div class="an-card"><div class="an-card-val">${Lt}%</div><div class="an-card-label">${t("an.convRate")}</div></div></div>`,dt.length?(N+='<div class="an-bars">',dt.forEach(([e,n])=>{const o=n/_t*100;N+=`<div class="an-bar-row"><div class="an-bar-label">${e}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-conv" style="width:${o}%"></div></div><div class="an-bar-val">${n}</div></div>`}),N+="</div>"):N+='<div class="an-empty">'+t("an.noTaps")+"</div>",N+="</div>";const ct=Object.entries(i.daily).sort((e,n)=>e[0].localeCompare(n[0])),Z=Math.max(...ct.map(e=>e[1]),1);let W=`<div class="an-section"><div class="an-section-title">${t("an.dailyVisitors")} <span class="an-hint">${t("an.dailyHint")}</span></div><div class="an-trend an-trend-dual">`;ct.forEach(([e,n])=>{const o=i.dailyUniqueCounts[e]||0,c=n/Z*100,b=o/Z*100,w=e.slice(5);W+=`<div class="an-trend-bar" title="${e}: ${n} hits, ${o} uniques">
    <div class="an-trend-fill" style="height:${Math.max(c,2)}%"></div>
    <div class="an-trend-fill an-trend-unique" style="height:${Math.max(b,2)}%"></div>
    <div class="an-trend-label">${w}</div>
  </div>`}),ct.length||(W+='<div class="an-empty">'+t("an.noLogs")+"</div>"),W+="</div>",ct.length&&(W+=`<div class="an-legend"><span class="an-legend-dot an-legend-hits"></span> ${t("an.legendHits")} <span class="an-legend-dot an-legend-uniques"></span> ${t("an.legendUniques")}</div>`),W+="</div>";const Dt=[t("date.sun"),t("date.mon"),t("date.tue"),t("date.wed"),t("date.thu"),t("date.fri"),t("date.sat")],ft=e=>e===0?"12a":e<12?e+"a":e===12?"12p":e-12+"p",kt=Math.max(...P.flat(),1);let Y=`<div class="an-section"><div class="an-section-title">${t("an.peakHours")} <span class="an-hint">${t("an.peakHint")}</span></div><div class="an-heatmap-wrap"><div class="an-heatmap-inner">`;Y+='<div class="an-heatmap-dow"></div>';for(let e=0;e<24;e++)Y+=`<div class="an-heatmap-hr">${e%3===0?ft(e):""}</div>`;for(let e=0;e<7;e++){Y+=`<div class="an-heatmap-dow">${Dt[e]}</div>`;for(let n=0;n<24;n++){const o=P[e][n],c=o===0?.05:Math.max(.12,o/kt);Y+=`<div class="an-heatmap-cell" style="opacity:${c.toFixed(2)}" title="${Dt[e]} ${ft(n)}: ${t("an.visitCount").replace("{n}",o)}"></div>`}}Y+="</div></div></div>";const Q=Object.entries(i.pageViewsTotal).sort((e,n)=>n[1]-e[1]).slice(0,15),tt=Q.length?Q[0][1]:1;let et=`<div class="an-section"><div class="an-section-title">${t("an.pageViews")} <span class="an-hint">${t("an.pvHint")}</span></div><div class="an-bars">`;Q.forEach(([e,n])=>{const o=i.pageViewsUniqueCounts[e]||0,c=n/tt*100,b=e==="/"?"Home":e.replace(/^\//,"").replace(/\//g," â€º ");et+=`<div class="an-bar-row"><div class="an-bar-label" title="${e}">${b}</div><div class="an-bar-track"><div class="an-bar-fill" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),Q.length||(et+='<div class="an-empty">'+t("an.noPV")+"</div>"),et+="</div></div>";const nt=(typeof girls<"u"?girls.filter(e=>e&&e.name&&String(e.name).trim()):[]).map(e=>({name:e.name,total:i.profileViewsTotal[e.name]||0,unique:i.profileViewsUniqueCounts[e.name]||0,girl:e})).sort((e,n)=>n.total-e.total),Et=nt.length&&nt[0].total>0?nt[0].total:1;let vt=`<div class="an-section"><div class="an-section-title">${t("an.mostProfiles")} <span class="an-hint">${t("an.pfHint")}</span></div><div class="an-bars">`;nt.forEach(({name:e,total:n,unique:o,girl:c},b)=>{const w=n>0?n/Et*100:0,R=b===0&&n>0?"ðŸ¥‡":b===1&&n>0?"ðŸ¥ˆ":b===2&&n>0?"ðŸ¥‰":"",x=c.photos&&c.photos.length?`<img class="an-profile-thumb" src="${c.photos[0]}" alt="${e.replace(/"/g,"&quot;")}">`:'<div class="an-profile-thumb an-profile-thumb-empty"></div>',B=typeof isAvailableNow=="function"&&isAvailableNow(e)?'<span class="avail-now-dot" title="Available now"></span>':"";vt+=`<div class="an-bar-row" style="${n===0?"opacity:0.4":""}"><div class="an-bar-label an-bar-label-profile">${x}<span>${R} ${e}</span>${B}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-profile" style="width:${w}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),nt.length||(vt+='<div class="an-empty">'+t("an.noPF")+"</div>"),vt+="</div></div>";const ut=Object.entries(i.browsers).sort((e,n)=>n[1]-e[1]),a=ut.length?ut[0][1]:1;let f=`<div class="an-section"><div class="an-section-title">${t("an.browsers")} <span class="an-hint">${t("an.pvHint")}</span></div><div class="an-bars">`;ut.forEach(([e,n])=>{const o=i.browsersUniqueCounts[e]||0,c=n/a*100;f+=`<div class="an-bar-row"><div class="an-bar-label">${e}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-visitor" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),ut.length||(f+='<div class="an-empty">'+t("an.noData")+"</div>"),f+="</div></div>";const d=Object.entries(i.oses).sort((e,n)=>n[1]-e[1]),h=d.length?d[0][1]:1;let $=`<div class="an-section"><div class="an-section-title">${t("an.os")} <span class="an-hint">${t("an.pvHint")}</span></div><div class="an-bars">`;d.forEach(([e,n])=>{const o=i.osesUniqueCounts[e]||0,c=n/h*100;$+=`<div class="an-bar-row"><div class="an-bar-label">${e}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-os" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),d.length||($+='<div class="an-empty">'+t("an.noData")+"</div>"),$+="</div></div>";const D=Object.entries(i.devices).sort((e,n)=>n[1]-e[1]),T=D.length?D[0][1]:1;let y=`<div class="an-section"><div class="an-section-title">${t("an.devices")} <span class="an-hint">${t("an.pvHint")}</span></div><div class="an-bars">`;D.forEach(([e,n])=>{const o=i.devicesUniqueCounts[e]||0,c=n/T*100;y+=`<div class="an-bar-row"><div class="an-bar-label">${e}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-device" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),D.length||(y+='<div class="an-empty">'+t("an.noData")+"</div>"),y+="</div></div>";const q=Object.entries(i.languages).sort((e,n)=>n[1]-e[1]).slice(0,10),U=q.length?q[0][1]:1;let _=`<div class="an-section"><div class="an-section-title">${t("an.languages")} <span class="an-hint">${t("an.pvHint")}</span></div><div class="an-bars">`;q.forEach(([e,n])=>{const o=i.languagesUniqueCounts[e]||0,c=n/U*100;_+=`<div class="an-bar-row"><div class="an-bar-label">${e}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-lang" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),q.length||(_+='<div class="an-empty">'+t("an.noData")+"</div>"),_+="</div></div>";const k=Object.entries(i.siteLanguages).sort((e,n)=>n[1]-e[1]),ht=k.length?k[0][1]:1;let I=`<div class="an-section"><div class="an-section-title">${t("an.siteLanguages")} <span class="an-hint">${t("an.pvHint")}</span></div><div class="an-bars">`;k.forEach(([e,n])=>{const o=i.siteLanguagesUniqueCounts[e]||0,c=n/ht*100;I+=`<div class="an-bar-row"><div class="an-bar-label">${e}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-lang" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),k.length||(I+='<div class="an-empty">'+t("an.noData")+"</div>"),I+="</div></div>";const G=Object.entries(i.timezones).sort((e,n)=>n[1]-e[1]).slice(0,10),at=G.length?G[0][1]:1;let J=`<div class="an-section"><div class="an-section-title">${t("an.timezones")} <span class="an-hint">${t("an.pvHint")}</span></div><div class="an-bars">`;G.forEach(([e,n])=>{const o=i.timezonesUniqueCounts[e]||0,c=n/at*100,b=e.replace("Australia/","AU/").replace("America/","US/").replace("Europe/","EU/").replace("Asia/","AS/");J+=`<div class="an-bar-row"><div class="an-bar-label" title="${e}">${b}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-tz" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),G.length||(J+='<div class="an-empty">'+t("an.noData")+"</div>"),J+="</div></div>";const j=Object.entries(i.referrers).sort((e,n)=>n[1]-e[1]).slice(0,10),gt=j.length?j[0][1]:1;let V=`<div class="an-section"><div class="an-section-title">${t("an.referrers")} <span class="an-hint">${t("an.pvHint")}</span></div><div class="an-bars">`;j.forEach(([e,n])=>{const o=i.referrersUniqueCounts[e]||0,c=n/gt*100;V+=`<div class="an-bar-row"><div class="an-bar-label">${e}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-ref" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),j.length||(V+='<div class="an-empty">'+t("an.noData")+"</div>"),V+="</div></div>";const st={country:"Country",age:"Age",body:"Body",height:"Height",cup:"Cup",rate30:"30min Rate",rate45:"45min Rate",rate60:"60min Rate",experience:"Experience",labels:"Labels"},L=Object.entries(i.filterDimensions).sort((e,n)=>n[1]-e[1]),mt=L.length?L[0][1]:1;let F=`<div class="an-section"><div class="an-section-title">${t("an.filterPatterns")} <span class="an-hint">${t("an.filterHint")}</span></div><div class="an-bars">`;L.forEach(([e,n])=>{const o=i.filterDimensionsUniqueCounts[e]||0,c=n/mt*100,b=st[e]||e;F+=`<div class="an-bar-row"><div class="an-bar-label">${b}</div><div class="an-bar-track"><div class="an-bar-fill an-bar-filter" style="width:${c}%"></div></div><div class="an-bar-val">${n} <span class="an-bar-unique">/ ${o}</span></div></div>`}),L.length||(F+='<div class="an-empty">'+t("an.noFilters")+"</div>"),F+="</div></div>";const pt=v.filter(e=>e.type==="session"||!e.type),K=new Set,it=[];for(let e=pt.length-1;e>=0;e--){const n=pt[e];let o="";try{const b=new Date(n.timestamp),w=new Date(b.toLocaleString("en-US",{timeZone:"Australia/Sydney"}));o=w.getFullYear()+"-"+String(w.getMonth()+1).padStart(2,"0")+"-"+String(w.getDate()).padStart(2,"0")}catch{o="unknown"}const c=(n.uuid||"anon")+"|"+o;if(K.has(c)||(K.add(c),it.push({...n,_day:o})),it.length>=20)break}let M=`<div class="an-section"><div class="an-section-title">${t("an.recentVisitors")} <span class="an-hint">${t("an.recentHint")}</span></div>`;it.length?(M+=`<div class="an-table-wrap"><table class="an-table"><thead><tr><th>${t("an.tableDate")}</th><th>UUID</th><th>${t("an.tableBrowser")}</th><th>${t("an.tableOS")}</th><th>${t("an.tableDevice")}</th><th>${t("an.tableLang")}</th><th>${t("an.tableSiteLang")}</th><th>${t("an.tableTZ")}</th></tr></thead><tbody>`,it.forEach(e=>{const n=[t("date.jan"),t("date.feb"),t("date.mar"),t("date.apr"),t("date.may"),t("date.jun"),t("date.jul"),t("date.aug"),t("date.sep"),t("date.oct"),t("date.nov"),t("date.dec")],o=e._day!=="unknown"?function(bt){const yt=new Date(bt+"T00:00:00");return yt.getDate()+" "+n[yt.getMonth()]}(e._day):"â€”",c=(e.uuid||"â€”").slice(0,12),b=e.browser||"â€”",w=e.os||"â€”",R=e.device||"â€”",x=(e.language||"â€”").split("-")[0],ot=e.siteLang||"â€”",B=(e.timezone||"â€”").replace("Australia/","AU/").replace("America/","US/");M+=`<tr><td>${o}</td><td class="an-mono">${c}</td><td>${b}</td><td>${w}</td><td>${R}</td><td>${x}</td><td>${ot}</td><td title="${e.timezone||""}">${B}</td></tr>`}),M+="</tbody></table></div>"):M+='<div class="an-empty">'+t("an.noLogs")+"</div>",M+="</div>";const Ut=`<div class="an-actions">
<button class="an-action-btn" id="anExportVisitors">${t("an.export")}</button>
<button class="an-action-btn" id="anRefreshVisitors">${t("an.refresh")}</button>
</div>`;r.innerHTML=g+qt+H+N+W+Y+'<div class="an-two-col">'+et+vt+'</div><div class="an-two-col">'+f+$+'</div><div class="an-two-col">'+y+_+'</div><div class="an-two-col">'+I+J+'</div><div class="an-two-col">'+V+F+"</div>"+M+Ut,r.querySelectorAll(".an-period-btn").forEach(e=>{e.onclick=()=>{analyticsPeriod=parseInt(e.dataset.days),cachedVisitorData=null,renderAnalytics()}}),document.getElementById("anExportVisitors").onclick=()=>{const e=new Blob([JSON.stringify(v,null,2)],{type:"application/json"}),n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download="ginza-visitors-"+_todayStr()+".json",o.click(),URL.revokeObjectURL(n),showToast(t("an.exported"))},document.getElementById("anRefreshVisitors").onclick=()=>{cachedVisitorData=null,renderAnalytics()}}async function renderAdminLog(){if(!isAdmin())return;const r=document.getElementById("adminLogContent");if(r){r.innerHTML='<div class="an-section"><div class="an-section-title">Activity Log <span class="an-hint">Last 50 admin actions</span></div><div class="an-loading"><div class="an-loading-spinner"></div><div class="an-loading-text">Loadingâ€¦</div></div></div>';try{const l=await fetch(`${DATA_API}/${ALP}`,{headers:proxyHeaders()});if(!l.ok){r.innerHTML='<div class="an-section"><div class="an-section-title">Activity Log</div><div class="an-empty">No activity recorded yet</div></div>';return}const g=await l.json(),p=[...dec(g.content)].reverse().slice(0,50),m={profile_add:"Added profile",profile_edit:"Edited profile",profile_delete:"Deleted profile",user_role_change:"Changed role",user_delete:"Deleted user",csv_import:"CSV import"};let v='<div class="an-section"><div class="an-section-title">Activity Log <span class="an-hint">Last 50 admin actions</span></div>';if(!p.length){v+='<div class="an-empty">No activity recorded yet</div></div>',r.innerHTML=v;return}v+='<table class="pdb-table"><thead><tr><th>Time (AEDT)</th><th>Admin</th><th>Action</th><th>Target</th></tr></thead><tbody>',p.forEach(i=>{let P="";try{P=new Date(i.ts).toLocaleString("en-AU",{timeZone:"Australia/Sydney",dateStyle:"short",timeStyle:"short"})}catch{P=i.ts||""}const z=m[i.action]||i.action||"";let O=i.target||"";i.newRole&&(O+=` â†’ ${i.newRole}`),v+=`<tr><td style="white-space:nowrap;font-size:12px">${P}</td><td><b>${(i.admin||"").toUpperCase()}</b></td><td>${z}</td><td>${O}</td></tr>`}),v+="</tbody></table></div>",r.innerHTML=v}catch{r.innerHTML='<div class="an-section"><div class="an-empty">Could not load activity log</div></div>'}}}(function(){const r=showPage;window.showPage=function(l){r(l);const g=l.replace("Page","");VisitorLog.trackPageView(g),l==="analyticsPage"&&renderAnalytics()}})(),function(){const r=showProfile;window.showProfile=function(l){r(l);const g=girls[l];g&&g.name&&VisitorLog.trackProfileView(g.name)}}(),function(){const r=renderDropdown;window.renderDropdown=function(){r();const l=document.getElementById("navAnalytics"),g=document.getElementById("navProfileDb");isAdmin()?(l&&(l.style.display=""),g&&(g.style.display="")):(l&&(l.style.display="none"),g&&(g.style.display="none"),(document.getElementById("analyticsPage").classList.contains("active")||document.getElementById("profileDbPage").classList.contains("active"))&&showPage("homePage"))}}();let _pdbSearch="",_pdbRoleFilter="";function renderProfileDb(){if(!isAdmin())return;const r=document.getElementById("profileDbContent");if(!r)return;let l='<div class="pdb-filters"><input class="pdb-search" id="pdbSearch" type="text" placeholder="'+t("pdb.searchPlaceholder")+'" value="'+(_pdbSearch||"").replace(/"/g,"&quot;")+'">';l+='<select class="pdb-role-filter" id="pdbRoleFilter"><option value=""'+(_pdbRoleFilter===""?" selected":"")+">"+t("pdb.allRoles")+'</option><option value="admin"'+(_pdbRoleFilter==="admin"?" selected":"")+'>Admin</option><option value="member"'+(_pdbRoleFilter==="member"?" selected":"")+">Member</option></select></div>";const g=_pdbSearch.toLowerCase(),rt=CRED.map((m,v)=>({c:m,i:v})).filter(({c:m})=>{if(m.role==="owner"||_pdbRoleFilter&&m.role!==_pdbRoleFilter)return!1;if(g){const v=(m.user||"").toLowerCase(),i=(m.email||"").toLowerCase(),P=(m.mobile||"").toLowerCase();if(!v.includes(g)&&!i.includes(g)&&!P.includes(g))return!1}return!0});l+='<table class="pdb-table"><thead><tr><th>'+t("pdb.username")+"</th><th>"+t("field.email")+"</th><th>"+t("field.mobile")+"</th><th>"+t("pdb.role")+"</th><th>Booking</th><th></th></tr></thead><tbody>",rt.length||(l+='<tr><td colspan="6" style="text-align:center;color:var(--text-dim);padding:24px">'+t("pdb.noResults")+"</td></tr>"),rt.forEach(({c:m,i:v})=>{const i=m.user===loggedInUser;l+='<tr><td class="pdb-user">'+(m.user||"").toUpperCase()+"</td><td>"+(m.email||"â€”")+"</td><td>"+(m.mobile||"â€”")+'</td><td><select class="pdb-role-select" data-cred-idx="'+v+'"><option value="admin"'+(m.role==="admin"?" selected":"")+'>Admin</option><option value="member"'+(m.role==="member"?" selected":"")+">Member</option></select></td><td>"++(()=>{const bk=Array.isArray(calData._bookings)&&calData._bookings.find(b=>b.user===m.user&&b.status==="pending");return bk?'<span class="pdb-bk-badge">'+bk.girlName+" &middot; "+dispDate(bk.date).day+" "+dispDate(bk.date).date+"</span>":"â€”"})()+"</td><td>"+(i?"":'<button class="pdb-delete-btn" data-cred-idx="'+v+'" title="'+t("pdb.deleteUser")+'">&#x2715;</button>')+"</td></tr>"}),l+="</tbody></table>",r.innerHTML=l;const p=document.getElementById("pdbSearch");p.oninput=()=>{_pdbSearch=p.value,renderProfileDb()},p.focus(),p.setSelectionRange(p.value.length,p.value.length),document.getElementById("pdbRoleFilter").onchange=function(){_pdbRoleFilter=this.value,renderProfileDb()},r.querySelectorAll(".pdb-role-select").forEach(m=>{m.onchange=async function(){const v=parseInt(this.dataset.credIdx),i=this.value;if(CRED[v].user===loggedInUser&&i!=="admin"){this.value="admin",showToast(t("pdb.cannotDemoteSelf"));return}CRED[v].role=i,await saveAuth()?(logAdminAction("user_role_change",CRED[v].user,{newRole:i}),showToast(t("pdb.roleUpdated"))):showToast(t("pdb.saveFailed"))}}),r.querySelectorAll(".pdb-delete-btn").forEach(m=>{m.onclick=async function(){const v=parseInt(this.dataset.credIdx),i=(CRED[v].user||"").toUpperCase();confirm(t("pdb.confirmDelete").replace("{user}",i))&&(CRED.splice(v,1),await saveAuth()?(logAdminAction("user_delete",i),showToast(t("pdb.userDeleted")),renderProfileDb()):showToast(t("pdb.saveFailed")))}})}document.querySelectorAll(".fab-item.fab-call").forEach(r=>{r.addEventListener("click",()=>{const l=(r.getAttribute("href")||"").replace("tel:+61","0").replace(/\D/g,"");VisitorLog.trackPhoneTap(l)})}),function(){const r=onFiltersChanged;window.onFiltersChanged=function(){r();const l=[];sharedFilters.country&&sharedFilters.country.length&&l.push("country"),(sharedFilters.ageMin!=null||sharedFilters.ageMax!=null)&&l.push("age"),(sharedFilters.bodyMin!=null||sharedFilters.bodyMax!=null)&&l.push("body"),(sharedFilters.heightMin!=null||sharedFilters.heightMax!=null)&&l.push("height"),sharedFilters.cupSize&&l.push("cup"),(sharedFilters.val1Min!=null||sharedFilters.val1Max!=null)&&l.push("rate30"),(sharedFilters.val2Min!=null||sharedFilters.val2Max!=null)&&l.push("rate45"),(sharedFilters.val3Min!=null||sharedFilters.val3Max!=null)&&l.push("rate60"),sharedFilters.experience&&l.push("experience"),sharedFilters.labels&&sharedFilters.labels.length&&l.push("labels"),l.length&&VisitorLog.trackFilterUse(l)}}();
