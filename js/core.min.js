const PROXY="https://github-proxy.sydneyginza-api-2.workers.dev",DATA_REPO="sydneyginza/files",SITE_REPO="sydneyginza/sydneyginza.github.io",DATA_API=`${PROXY}/repos/${DATA_REPO}/contents`,SITE_API=`${PROXY}/repos/${SITE_REPO}/contents`,DP="data/girls.json",AP="data/auth.json",KP="data/calendar.json",CP="data/config.json",RHP="data/roster_history.json",ALP="data/admin_log.json";let loggedIn=!1,dataSha=null,calSha=null,calData={},loggedInUser=null,loggedInRole=null,loggedInEmail=null,loggedInMobile=null,authSha=null,MAX_PHOTOS=10,profileReturnPage="homePage";function isAdmin(){return loggedIn&&(loggedInRole==="admin"||loggedInRole==="owner")}let rosterHistory={},rosterHistorySha=null,girls=[],GT=!0;function proxyHeaders(){return{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}}function showToast(e,n="success"){const a=document.getElementById("toast");a.textContent=e,a.className="toast "+n+" show",clearTimeout(a._t),a._t=setTimeout(()=>a.classList.remove("show"),3e3)}function getAEDTDate(){return new Date(new Date().toLocaleString("en-US",{timeZone:"Australia/Sydney"}))}function fmtDate(e){return e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0")}function getWeekDates(){const e=getAEDTDate(),n=[];for(let a=0;a<7;a++){const r=new Date(e);r.setDate(e.getDate()+a),n.push(fmtDate(r))}return n}function dispDate(e){const n=new Date(e+"T00:00:00"),a=typeof t=="function"?t:i=>["date.sun","date.mon","date.tue","date.wed","date.thu","date.fri","date.sat","date.jan","date.feb","date.mar","date.apr","date.may","date.jun","date.jul","date.aug","date.sep","date.oct","date.nov","date.dec"].indexOf(i)<0?i:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][["date.sun","date.mon","date.tue","date.wed","date.thu","date.fri","date.sat","date.jan","date.feb","date.mar","date.apr","date.may","date.jun","date.jul","date.aug","date.sep","date.oct","date.nov","date.dec"].indexOf(i)],r=["date.sun","date.mon","date.tue","date.wed","date.thu","date.fri","date.sat"],s=["date.jan","date.feb","date.mar","date.apr","date.may","date.jun","date.jul","date.aug","date.sep","date.oct","date.nov","date.dec"];return{date:n.getDate()+" "+a(s[n.getMonth()]),day:a(r[n.getDay()])}}function dec(e){return JSON.parse(decodeURIComponent(escape(atob(e.replace(/\n/g,"")))))}function enc(e){return btoa(unescape(encodeURIComponent(JSON.stringify(e,null,2))))}function fmtTime12(e){if(!e)return"";const[n,a]=e.split(":").map(Number),r=n<12?"AM":"PM";return(n===0?12:n>12?n-12:n)+":"+String(a).padStart(2,"0")+" "+r}function getCalEntry(e,n){if(calData[e]&&calData[e][n]){const a=calData[e][n];return typeof a=="object"?a:{start:"",end:""}}return null}function isAvailableNow(e){const n=getAEDTDate(),a=fmtDate(n),r=getCalEntry(e,a);if(!r||!r.start||!r.end)return!1;const s=n.getHours()*60+n.getMinutes(),[i,c]=r.start.split(":").map(Number),[o,d]=r.end.split(":").map(Number),l=i*60+c,g=o*60+d;return g<=l?s>=l||s<g:s>=l&&s<g}function getAvailCountdown(e){const n=getAEDTDate(),a=getCalEntry(e,fmtDate(n));if(!a||!a.start||!a.end)return null;const r=n.getHours()*60+n.getMinutes(),[s,i]=a.start.split(":").map(Number),[c,o]=a.end.split(":").map(Number),d=s*60+i,l=c*60+o,g=f=>{const h=Math.floor(f/60),y=f%60;return h>0?`${h}h ${y}m`:`${y}m`};if(isAvailableNow(e)){let f=l-r;return f<=0&&(f+=1440),{type:"ends",str:g(f)}}const u=d-r;return u>0&&u<=720?{type:"starts",str:g(u)}:null}function getAvailableNowCount(){return girls.filter(e=>e.name&&isAvailableNow(e.name)).length}function isAvailableToday(e){const n=getCalEntry(e,fmtDate(getAEDTDate()));return!!(n&&n.start&&n.end)}function getAvailableTodayCount(){return girls.filter(e=>e.name&&isAvailableToday(e.name)).length}function genFn(){return"img_"+Date.now()+"_"+Math.random().toString(36).substr(2,6)+".jpg"}const CACHE_KEY_GIRLS="ginza_cache_girls",CACHE_KEY_CAL="ginza_cache_cal",CACHE_KEY_GIRLS_SHA="ginza_cache_girls_sha",CACHE_KEY_CAL_SHA="ginza_cache_cal_sha",CACHE_KEY_CAL_TS="ginza_cache_cal_ts",CAL_CACHE_TTL=10*60*1e3;function cacheGet(e){try{const n=localStorage.getItem(e);return n?JSON.parse(n):null}catch{return null}}function cacheSet(e,n){try{localStorage.setItem(e,JSON.stringify(n))}catch{}}function cacheClear(){try{[CACHE_KEY_GIRLS,CACHE_KEY_CAL,CACHE_KEY_GIRLS_SHA,CACHE_KEY_CAL_SHA,CACHE_KEY_CAL_TS].forEach(e=>localStorage.removeItem(e))}catch{}}function getCachedGirls(){return cacheGet(CACHE_KEY_GIRLS)}function getCachedCal(){return cacheGet(CACHE_KEY_CAL)}function getCachedGirlsSha(){try{return localStorage.getItem(CACHE_KEY_GIRLS_SHA)||null}catch{return null}}function getCachedCalSha(){try{return localStorage.getItem(CACHE_KEY_CAL_SHA)||null}catch{return null}}function updateGirlsCache(){if(cacheSet(CACHE_KEY_GIRLS,girls),dataSha)try{localStorage.setItem(CACHE_KEY_GIRLS_SHA,dataSha)}catch{}}function updateCalCache(){if(cacheSet(CACHE_KEY_CAL,calData),calSha)try{localStorage.setItem(CACHE_KEY_CAL_SHA,calSha)}catch{}try{localStorage.setItem(CACHE_KEY_CAL_TS,Date.now().toString())}catch{}}function isCalCacheStale(){try{const e=localStorage.getItem(CACHE_KEY_CAL_TS);return!e||Date.now()-parseInt(e)>CAL_CACHE_TTL}catch{return!0}}function getFavorites(){if(!loggedIn||!loggedInUser)return[];const e=CRED.find(n=>n.user===loggedInUser);return e&&Array.isArray(e.favorites)?e.favorites:[]}function saveFavorites(e){if(!loggedIn||!loggedInUser)return;const n=CRED.find(a=>a.user===loggedInUser);n&&(n.favorites=e,saveAuth())}function isFavorite(e){return getFavorites().includes(e)}function toggleFavorite(e){const n=getFavorites(),a=n.indexOf(e);return a>=0?n.splice(a,1):n.push(e),saveFavorites(n),a<0}function getFavCount(){const e=getFavorites();return girls.filter(n=>n.name&&e.includes(n.name)).length}const RV_KEY="ginza_recently_viewed",RV_MAX=20;function getRecentlyViewed(){try{const e=localStorage.getItem(RV_KEY);return e?JSON.parse(e):[]}catch{return[]}}function addRecentlyViewed(e){if(!e)return;let n=getRecentlyViewed();n=n.filter(a=>a.name!==e),n.unshift({name:e,ts:Date.now()}),n.length>RV_MAX&&(n=n.slice(0,RV_MAX));try{localStorage.setItem(RV_KEY,JSON.stringify(n))}catch{}}function clearRecentlyViewed(){try{localStorage.removeItem(RV_KEY)}catch{}}async function fetchWithRetry(e,n={},{retries:a=3,baseDelay:r=600}={}){let s;for(let i=0;i<=a;i++)try{const c=await fetch(e,n);if(c.ok||c.status>=400&&c.status<500&&c.status!==429)return c;if(s=new Error(`HTTP ${c.status}`),i<a){const o=c.headers.get("Retry-After"),d=o?parseInt(o)*1e3:r*Math.pow(2,i);await new Promise(l=>setTimeout(l,d))}}catch(c){s=c,i<a&&await new Promise(o=>setTimeout(o,r*Math.pow(2,i)))}throw s}async function loadAuth(){try{const e=await fetchWithRetry(`${DATA_API}/${AP}`,{headers:proxyHeaders()});if(e.ok){const n=await e.json();return authSha=n.sha,dec(n.content)}if(e.status===404){const n=[{user:"admin",pass:"admin123"}];return await fetchWithRetry(`${DATA_API}/${AP}`,{method:"PUT",headers:proxyHeaders(),body:JSON.stringify({message:"Create auth",content:enc(n)})}),n}}catch(e){console.error("loadAuth error:",e)}return[]}async function saveAuth(e=!0){try{const n={message:"Update auth",content:enc(CRED)};authSha&&(n.sha=authSha);const a=await fetchWithRetry(`${DATA_API}/${AP}`,{method:"PUT",headers:proxyHeaders(),body:JSON.stringify(n)},{retries:2}),r=await a.json();if(!a.ok){if(a.status===409&&e){const s=await fetchWithRetry(`${DATA_API}/${AP}`,{headers:proxyHeaders()});if(s.ok)return authSha=(await s.json()).sha,saveAuth(!1)}throw new Error(r.message||a.status)}return authSha=r.content.sha,!0}catch(n){return showToast("Save failed: "+n.message,"error"),!1}}async function loadData(){try{const e=await fetchWithRetry(`${DATA_API}/${DP}`,{headers:proxyHeaders()});if(e.ok){const n=await e.json();return dataSha=n.sha,dec(n.content)}if(e.status===404)return dataSha=null,[]}catch(e){console.error("loadData error:",e)}return null}async function saveData(e=!0){try{const n={message:"Update girls",content:enc(girls)};dataSha&&(n.sha=dataSha);const a=await fetchWithRetry(`${DATA_API}/${DP}`,{method:"PUT",headers:proxyHeaders(),body:JSON.stringify(n)},{retries:2}),r=await a.json();if(!a.ok){if(a.status===409&&e){console.warn("Save conflict — refetching SHA and retrying");const s=await fetchWithRetry(`${DATA_API}/${DP}`,{headers:proxyHeaders()});if(s.ok)return dataSha=(await s.json()).sha,saveData(!1)}throw new Error(r.message||a.status)}return dataSha=r.content.sha,updateGirlsCache(),!0}catch(n){return showToast("Save failed: "+n.message,"error"),!1}}async function loadCalData(){try{const e=await fetchWithRetry(`${DATA_API}/${KP}`,{headers:proxyHeaders()});if(e.ok){const n=await e.json();return calSha=n.sha,dec(n.content)}if(e.status===404)return calSha=null,{}}catch(e){console.error("loadCalData error:",e)}return{}}async function saveCalData(e=!0){try{const n=getWeekDates(),a={};for(const o in calData){a[o]={};for(const d of n)calData[o]&&calData[o][d]&&(a[o][d]=calData[o][d])}calData=a;const r={message:"Update calendar",content:enc(calData)};calSha&&(r.sha=calSha);const s=await fetchWithRetry(`${DATA_API}/${KP}`,{method:"PUT",headers:proxyHeaders(),body:JSON.stringify(r)},{retries:2});if(!s.ok){if(s.status===409&&e){console.warn("Calendar save conflict — refetching SHA and retrying");const o=await fetchWithRetry(`${DATA_API}/${KP}`,{headers:proxyHeaders()});if(o.ok)return calSha=(await o.json()).sha,saveCalData(!1)}throw new Error(s.status)}calSha=(await s.json()).content.sha,updateCalCache();const i=fmtDate(getAEDTDate());let c=!1;for(const o in calData)for(const d of Object.keys(calData[o]||{})){const l=calData[o][d];d<=i&&l&&l.start&&l.end&&(!rosterHistory[o]||d>rosterHistory[o])&&(rosterHistory[o]=d,c=!0)}return c&&saveRosterHistory(),!0}catch{return showToast("Calendar save failed","error"),!1}}async function loadRosterHistory(){try{const e=await fetchWithRetry(`${DATA_API}/${RHP}`,{headers:proxyHeaders()});if(e.ok){const n=await e.json();rosterHistorySha=n.sha,rosterHistory=dec(n.content)||{};return}e.status===404&&(rosterHistorySha=null,rosterHistory={})}catch{}}async function saveRosterHistory(){try{const e={message:"Update roster history",content:enc(rosterHistory)};rosterHistorySha&&(e.sha=rosterHistorySha);const n=await fetchWithRetry(`${DATA_API}/${RHP}`,{method:"PUT",headers:proxyHeaders(),body:JSON.stringify(e)});n.ok&&(rosterHistorySha=(await n.json()).content.sha)}catch{}}function getLastRostered(e){return rosterHistory[e]||null}async function uploadToGithub(e,n,a){const s=`Images/${n.replace(/[^a-zA-Z0-9_-]/g,"_")}/${a}`,i=e.split(",")[1];let c;try{const l=await fetchWithRetry(`${SITE_API}/${s}`,{headers:proxyHeaders()});l.ok&&(c=(await l.json()).sha)}catch{}const o={message:`Upload ${s}`,content:i};c&&(o.sha=c);const d=await fetchWithRetry(`${SITE_API}/${s}`,{method:"PUT",headers:proxyHeaders(),body:JSON.stringify(o)},{retries:2});if(!d.ok)throw new Error(d.status);return`https://raw.githubusercontent.com/${SITE_REPO}/main/${s}`}async function deleteFromGithub(e){try{const n=e.match(/raw\.githubusercontent\.com\/([^/]+\/[^/]+)\/[^/]+\/(.+?)(\?|$)/);if(!n)return;const a=n[1],r=decodeURIComponent(n[2]),s=`${PROXY}/repos/${a}/contents/${r}`,i=await fetchWithRetry(s,{headers:proxyHeaders()});if(!i.ok)return;await fetchWithRetry(s,{method:"DELETE",headers:proxyHeaders(),body:JSON.stringify({message:"Delete",sha:(await i.json()).sha})},{retries:2})}catch(n){console.error("deleteFromGithub error:",n)}}let _calSaveTimer=null,_calSaving=!1,_calSaveQueued=!1,_calSavingCells=new Set;function _markCellSaving(e){e&&(e.classList.add("cal-saving"),_calSavingCells.add(e))}function _clearSavingCells(){_calSavingCells.forEach(e=>e.classList.remove("cal-saving")),_calSavingCells.clear()}async function _execCalSave(){if(_calSaving){_calSaveQueued=!0;return}_calSaving=!0;try{await saveCalData(),renderRoster(),renderGrid(),renderHome()}finally{_calSaving=!1,_clearSavingCells(),_calSaveQueued&&(_calSaveQueued=!1,_execCalSave())}}function queueCalSave(e,n){_markCellSaving(e),clearTimeout(_calSaveTimer),_calSaveTimer=setTimeout(()=>_execCalSave(),n??800)}function flushCalSave(){clearTimeout(_calSaveTimer),(_calSavingCells.size>0||_calSaveQueued)&&_execCalSave()}async function loadConfig(){return!0}function safeRender(e,n){try{n()}catch(a){console.error(`[${e}] render error:`,a),showToast(`${e} render failed`,"error")}}function safeCardRender(e,n,a){try{return a(e,n)}catch(r){return console.warn(`[Card] skipped index ${n} (${e&&e.name||"unnamed"}):`,r),null}}function showErrorState(e,n,a){const r=document.getElementById(e);if(!r)return;r.innerHTML=`<div class="error-state">
    <div class="error-state-icon">!</div>
    <div class="error-state-msg">${n}</div>
    <button class="error-state-retry">${typeof t=="function"?t("ui.retry"):"Retry"}</button>
  </div>`;const s=r.querySelector(".error-state-retry");s&&a&&(s.onclick=async()=>{s.disabled=!0,s.textContent=typeof t=="function"?t("ui.retrying"):"Retrying...";try{await a()}catch{s.disabled=!1,s.textContent=typeof t=="function"?t("ui.retry"):"Retry"}})}let _isOffline=!navigator.onLine;function initOfflineDetection(){const e=document.getElementById("offlineBanner");if(!e)return;function n(){_isOffline=!navigator.onLine,e.classList.toggle("visible",_isOffline),_isOffline||showToast(typeof t=="function"?t("ui.backOnline"):"Back online","success")}window.addEventListener("online",n),window.addEventListener("offline",n),_isOffline&&e.classList.add("visible")}function urlBase64ToUint8Array(e){const n="=".repeat((4-e.length%4)%4),a=(e+n).replace(/-/g,"+").replace(/_/g,"/"),r=atob(a),s=new Uint8Array(r.length);for(let i=0;i<r.length;i++)s[i]=r.charCodeAt(i);return s}async function getPushSubscription(){return"PushManager"in window?(await navigator.serviceWorker.ready).pushManager.getSubscription():null}async function subscribeToPush(){if(!("PushManager"in window)||!("Notification"in window)||await Notification.requestPermission()!=="granted")return null;const n=await navigator.serviceWorker.ready;try{const a=await fetch(PROXY+"/vapid-public-key");if(!a.ok)return null;const{key:r}=await a.json(),s=await n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:urlBase64ToUint8Array(r)});return await fetch(PROXY+"/push-subscribe",{method:"POST",headers:proxyHeaders(),body:JSON.stringify({username:loggedInUser,subscription:s.toJSON()})}),s}catch(a){return console.error("Push subscribe error:",a),null}}async function unsubscribeFromPush(){const e=await getPushSubscription();if(e){await e.unsubscribe();try{await fetch(PROXY+"/push-unsubscribe",{method:"POST",headers:proxyHeaders(),body:JSON.stringify({username:loggedInUser})})}catch{}}}const lazyObserver=new IntersectionObserver(e=>{e.forEach(n=>{if(n.isIntersecting){const a=n.target,r=a.dataset.src;r&&(a.src=r,a.onload=()=>a.classList.add("lazy-loaded"),a.onerror=()=>{a.classList.add("lazy-loaded")},delete a.dataset.src),lazyObserver.unobserve(a)}})},{rootMargin:"200px 0px",threshold:.01});function observeLazy(e){e&&e.querySelectorAll("img[data-src]").forEach(n=>lazyObserver.observe(n))}const iframeLazyObserver=new IntersectionObserver(e=>{e.forEach(n=>{if(n.isIntersecting){const a=n.target;a.dataset.src&&(a.src=a.dataset.src,delete a.dataset.src),iframeLazyObserver.unobserve(a)}})},{rootMargin:"300px 0px",threshold:0});document.querySelectorAll("iframe[data-src]").forEach(e=>iframeLazyObserver.observe(e));function lazyThumb(e,n,a){return`<img class="${n||"card-thumb"}" data-src="${e}" alt="${(a||"").replace(/"/g,"&quot;")}">`}function lazyCalAvatar(e,n){return`<img data-src="${e}" alt="${(n||"").replace(/"/g,"&quot;")}">`}const entranceObserver=new IntersectionObserver(e=>{e.forEach(n=>{if(n.isIntersecting){const a=n.target,r=parseInt(a.style.getPropertyValue("--card-index")||0)*60;a.classList.add("card-enter"),setTimeout(()=>{a.classList.remove("card-enter"),a.classList.add("card-entered")},r+500),entranceObserver.unobserve(a)}})},{rootMargin:"50px 0px",threshold:.05});function observeEntrance(e){e&&e.querySelectorAll(".girl-card").forEach((n,a)=>{n.style.setProperty("--card-index",Math.min(a,8)),entranceObserver.observe(n)})}const calEntranceObserver=new IntersectionObserver(e=>{e.forEach(n=>{if(n.isIntersecting){const a=n.target,r=parseInt(a.style.getPropertyValue("--row-index")||0)*50;a.classList.add("cal-row-enter"),setTimeout(()=>{a.classList.remove("cal-row-enter"),a.classList.add("cal-row-entered")},r+400),calEntranceObserver.unobserve(a)}})},{rootMargin:"30px 0px",threshold:.05});function observeCalEntrance(e){e&&e.querySelectorAll("tbody tr").forEach((n,a)=>{n.style.setProperty("--row-index",Math.min(a,10)),calEntranceObserver.observe(n)})}const Router=function(){const e={homePage:"/",rosterPage:"/roster",listPage:"/girls",favoritesPage:"/favorites",valuePage:"/rates",employmentPage:"/employment",calendarPage:"/calendar",analyticsPage:"/analytics",profileDbPage:"/profile-database"},n={};for(const u in e)n[e[u]]=u;function a(u){return encodeURIComponent((u||"").trim().replace(/\s+/g,"-"))}function r(u){return decodeURIComponent(u||"").replace(/-/g," ")}function s(u){const f=u.toLowerCase();return girls.findIndex(h=>h.name&&h.name.trim().toLowerCase()===f)}function i(u){return e[u]||"/"}function c(u){const f=girls[u];return!f||!f.name?"/girls":"/girls/"+a(f.name)}let o=!1;function d(u,f){if(o)return;const h=f||"Ginza Empire";document.title=h,window.location.pathname!==u&&history.pushState({path:u},h,u)}function l(u,f){if(o)return;const h=f||"Ginza Empire";document.title=h,history.replaceState({path:u},h,u)}function g(){typeof queryToFilters=="function"&&queryToFilters();const u=window.location.pathname,f=u.match(/^\/girls\/(.+)$/);if(f){const y=r(f[1]),m=s(y);return m>=0?(o=!0,profileReturnPage="listPage",showProfile(m),o=!1,!0):(o=!0,showPage("listPage"),o=!1,l("/girls","Ginza – Girls"),!0)}const h=n[u];return h?h==="favoritesPage"&&!loggedIn||h==="calendarPage"&&!isAdmin()||h==="analyticsPage"&&!isAdmin()||h==="profileDbPage"&&!isAdmin()?(o=!0,showPage("homePage"),o=!1,l("/","Ginza Empire"),!0):(o=!0,showPage(h),o=!1,!0):(u!=="/"&&(o=!0,showPage("homePage"),o=!1,l("/","Ginza Empire")),!0)}return window.addEventListener("popstate",function(){g()}),{PAGE_ROUTES:e,push:d,replace:l,resolve:g,pathForPage:i,pathForProfile:c,nameToSlug:a,slugToName:r,findGirlByName:s}}();async function logAdminAction(e,n,a={}){if(!loggedInUser)return;let r=[],s=null;try{const c=await fetch(`${DATA_API}/${ALP}`,{headers:proxyHeaders()});if(c.ok){const o=await c.json();s=o.sha,r=dec(o.content)}}catch{}r.length>=500&&(r=r.slice(r.length-499)),r.push({ts:new Date().toISOString(),admin:loggedInUser,action:e,target:n,...a});const i={message:`Log ${e}`,content:enc(r)};s&&(i.sha=s);try{await fetch(`${DATA_API}/${ALP}`,{method:"PUT",headers:proxyHeaders(),body:JSON.stringify(i)})}catch{}}
