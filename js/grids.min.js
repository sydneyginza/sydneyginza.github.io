let rosterAvailFilter=null;function renderFilters(){const r=document.getElementById("filterBar");r.innerHTML="";const o=document.createElement("div");o.className="inline-search-wrap";const c=document.createElement("input");c.type="text",c.className="inline-search-input",c.setAttribute("placeholder",t("ui.search")),c.setAttribute("aria-label",t("ui.search")),c.value=sharedFilters.nameSearch||"";let i;c.oninput=()=>{clearTimeout(i),i=setTimeout(()=>{sharedFilters.nameSearch=c.value,renderGrid(),renderRoster(),renderFavoritesGrid(),renderActiveFilterChips(),pushFiltersToURL()},200)},o.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="opacity:.4;flex-shrink:0"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>',o.appendChild(c),r.appendChild(o);const a=document.createElement("div");a.className="filter-sep",r.appendChild(a),[{key:"name",label:t("sort.name")},{key:"newest",label:t("sort.dateAdded")},{key:"age",label:t("sort.age")},{key:"body",label:t("sort.size")},{key:"height",label:t("sort.height")},{key:"cup",label:t("sort.cup")},{key:"lastSeen",label:t("sort.lastSeen")}].forEach(s=>{const n=document.createElement("button");n.className="sort-btn"+(gridSort===s.key?" active":""),n.textContent=s.label,n.onclick=()=>{gridSort===s.key?gridSortDir=gridSortDir==="asc"?"desc":"asc":(gridSort=s.key,gridSortDir=s.key==="newest"||s.key==="lastSeen"?"desc":"asc"),_persistSort(),renderFilters(),renderGrid(),renderRoster(),renderFavoritesGrid(),pushFiltersToURL()},r.appendChild(n)});const d=document.createElement("button");if(d.className="sort-dir-btn",d.title=gridSortDir==="asc"?"Ascending":"Descending",d.innerHTML=gridSortDir==="asc"?'<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M7 14l5-5 5 5z"/></svg><span class="sort-dir-label">ASC</span>':'<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg><span class="sort-dir-label">DESC</span>',d.onclick=()=>{gridSortDir=gridSortDir==="asc"?"desc":"asc",_persistSort(),renderFilters(),renderGrid(),renderRoster(),renderFavoritesGrid(),pushFiltersToURL()},r.appendChild(d),hasActiveFilters()){const s=document.createElement("div");s.className="filter-sep",r.appendChild(s);const n=document.createElement("button");n.className="filter-btn clear-filters-btn",n.innerHTML="&#10005; Clear",n.onclick=()=>{clearAllFilters(),onFiltersChanged()},r.appendChild(n)}if(isAdmin()){const s=document.createElement("button");s.className="add-btn",s.innerHTML="+ "+t("ui.addGirl"),s.onclick=()=>openForm(),r.appendChild(s)}}function renderAvailNowBar(){const r=document.getElementById("rosterAvailBar");if(!r)return;const o=fmtDate(getAEDTDate());if(rosterDateFilter!==o){rosterAvailFilter=null,r.innerHTML="",r.style.display="none";return}const c=getAEDTDate(),i=c.getHours()*60+c.getMinutes(),a=girls.filter(n=>{const l=getCalEntry(n.name,o);return l&&l.start&&l.end});let e=0,d=0,s=0;if(a.forEach(n=>{const l=getCalEntry(n.name,o),[u,v]=l.start.split(":").map(Number),[p,m]=l.end.split(":").map(Number),y=u*60+v,E=p*60+m;(E<=y?i>=y||i<E:i>=y&&i<E)?e++:E>y&&i>=E?s++:d++}),r.innerHTML="",!e&&!d&&!s){r.style.display="none";return}if(r.style.display="",e>0){const n=document.createElement("button");n.className="avail-now-pill"+(rosterAvailFilter==="now"?" active":"");const l=e===1&&siteLanguage==="en"?"1 girl available now":t("ui.girlsAvailNow").replace("{n}",e);n.innerHTML=`<span class="avail-now-dot"></span>${l}`,n.onclick=()=>{rosterAvailFilter=rosterAvailFilter==="now"?null:"now",renderAvailNowBar(),renderRosterGrid()},r.appendChild(n)}if(d>0){const n=document.createElement("button");n.className="avail-today-pill"+(rosterAvailFilter==="later"?" active":"");const l=d===1&&siteLanguage==="en"?"1 girl available later today":t("ui.girlsAvailLater").replace("{n}",d);n.innerHTML=`<span class="avail-today-dot"></span>${l}`,n.onclick=()=>{rosterAvailFilter=rosterAvailFilter==="later"?null:"later",renderAvailNowBar(),renderRosterGrid()},r.appendChild(n)}if(s>0){const n=document.createElement("button");n.className="avail-finished-pill"+(rosterAvailFilter==="finished"?" active":""),n.textContent=s+(s===1?" girl ":" girls ")+t("avail.finished").toLowerCase(),n.onclick=()=>{rosterAvailFilter=rosterAvailFilter==="finished"?null:"finished",renderAvailNowBar(),renderRosterGrid()},r.appendChild(n)}}function applySortOrder(r){const o=gridSortDir==="desc"?-1:1,c=(i,a,e)=>{const d=(i.name||"").trim(),s=(a.name||"").trim();return!d&&!s?0:d?s?e(i,a)*o:-1:1};return gridSort==="age"?r.sort((i,a)=>c(i,a,()=>{const e=parseFloat(i.age)||999,d=parseFloat(a.age)||999;return e-d})):gridSort==="newest"?r.sort((i,a)=>c(i,a,()=>{const e=i.startDate||"",d=a.startDate||"";return!e&&!d?0:e?d?d.localeCompare(e):-1:1})):gridSort==="body"?r.sort((i,a)=>c(i,a,()=>{const e=parseFloat(i.body)||999,d=parseFloat(a.body)||999;return e-d})):gridSort==="height"?r.sort((i,a)=>c(i,a,()=>{const e=parseFloat(i.height)||999,d=parseFloat(a.height)||999;return e-d})):gridSort==="cup"?r.sort((i,a)=>c(i,a,()=>(i.cup||"").toLowerCase().localeCompare((a.cup||"").toLowerCase()))):gridSort==="lastSeen"?r.sort((i,a)=>c(i,a,()=>{const e=getLastRostered(i.name)||"",d=getLastRostered(a.name)||"";return!e&&!d?0:e?d?d.localeCompare(e):-1:1})):r.sort((i,a)=>c(i,a,()=>(i.name||"").trim().toLowerCase().localeCompare((a.name||"").trim().toLowerCase())))}function daysAgo(r){const o=Math.floor((Date.now()-new Date(r))/864e5);return o===0?"Today":o===1?"Yesterday":o+" days ago"}const grid=document.getElementById("girlsGrid");function cardFavBtn(r){if(!loggedIn)return"";const o=r&&isFavorite(r);return`<button class="card-fav${o?" active":""}" data-fav-name="${r||""}" title="${o?"Remove from favorites":"Add to favorites"}">${favHeartSvg(o)}</button>`}function bindCardFavs(r){r.querySelectorAll(".card-fav").forEach(o=>{o.onclick=c=>{c.stopPropagation();const i=o.dataset.favName;if(!i)return;const a=toggleFavorite(i);o.classList.toggle("active",a),o.innerHTML=favHeartSvg(a),o.title=a?"Remove from favorites":"Add to favorites",o.classList.remove("fav-pop"),o.offsetWidth,o.classList.add("fav-pop"),updateFavBadge()}})}function cardRatingHtml(r){const o=r.reviews||[];if(!o.length)return"";const c=o.reduce((i,a)=>i+a.rating,0)/o.length;return'<div class="card-rating">'+renderStarsStatic(Math.round(c))+'<span class="card-rating-num">'+c.toFixed(1)+'</span><span class="card-rating-count">('+o.length+")</span></div>"}function cardCompareBtn(r){if(!r)return"";const o=isCompareSelected(r),c=compareSelected.length;return`<button class="card-compare${o?" active":""}" data-compare-name="${r}" title="${o?"Remove from compare":"Add to compare"}"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M9 3H3.5A1.5 1.5 0 002 4.5V9a1.5 1.5 0 001.5 1.5H9A1.5 1.5 0 0010.5 9V4.5A1.5 1.5 0 009 3zm11 0h-5.5A1.5 1.5 0 0013 4.5V9a1.5 1.5 0 001.5 1.5H20A1.5 1.5 0 0021.5 9V4.5A1.5 1.5 0 0020 3zM9 13.5H3.5A1.5 1.5 0 002 15v4.5A1.5 1.5 0 003.5 21H9a1.5 1.5 0 001.5-1.5V15A1.5 1.5 0 009 13.5zm11 0h-5.5A1.5 1.5 0 0013 15v4.5a1.5 1.5 0 001.5 1.5H20a1.5 1.5 0 001.5-1.5V15a1.5 1.5 0 00-1.5-1.5z"/></svg><span class="compare-badge" style="${o&&c>0?"":"display:none"}">${c}/${COMPARE_MAX}</span></button>`}function bindCardCompare(r){r.querySelectorAll(".card-compare").forEach(o=>{o.onclick=c=>{c.stopPropagation();const i=o.dataset.compareName;if(!i)return;const a=isCompareSelected(i);if(toggleCompare(i)!==!1){const d=a?"compare-shrink":"compare-pop";if(o.classList.remove("compare-pop","compare-shrink"),o.offsetWidth,o.classList.add(d),!a){const s=o.closest(".girl-card");s&&(s.classList.remove("compare-highlight"),s.offsetWidth,s.classList.add("compare-highlight"),setTimeout(()=>s.classList.remove("compare-highlight"),700))}}}})}function renderGrid(){safeRender("Girls Grid",()=>{let r=[...girls];isAdmin()||(r=r.filter(a=>!a.hidden)),r=applySharedFilters(r),loggedIn||(r=r.filter(a=>a.name&&String(a.name).trim().length>0)),applySortOrder(r),grid.innerHTML="";const o=fmtDate(getAEDTDate());let c,i=document.getElementById("gridResultsLive");if(i||(i=document.createElement("div"),i.id="gridResultsLive",i.setAttribute("role","status"),i.setAttribute("aria-live","polite"),i.className="sr-only",grid.parentElement.insertBefore(i,grid)),i.textContent=hasActiveFilters()?r.length+" results":"",!r.length&&hasActiveFilters()){grid.innerHTML=`<div class="fav-empty"><div class="fav-empty-icon" style="opacity:.15">&#x1F50D;</div><div class="fav-empty-text">${t("ui.noResults")}</div><button class="empty-state-cta" onclick="clearAllFilters();onFiltersChanged()">${t("ui.clearFilters")}</button></div>`;return}r.forEach((a,e)=>{const d=safeCardRender(a,e,()=>{const s=girls.indexOf(a),n=document.createElement("div");n.className="girl-card"+(a.hidden?" card-hidden":"");const l=a.hidden?"&#x1F441;":"&#x1F6AB;",u=a.hidden?t("ui.showGirl"):t("ui.hideGirl"),v=isAdmin()?`<div class="card-actions"><button class="card-action-btn hide-toggle${a.hidden?" active":""}" title="${u}" data-idx="${s}">${l}</button><button class="card-action-btn edit" title="Edit" data-idx="${s}">&#x270E;</button><button class="card-action-btn delete" title="Delete" data-idx="${s}">&#x2715;</button></div>`:"",p=a.photos&&a.photos.length?lazyThumb(a.photos[0],"card-thumb",a.name):'<div class="silhouette"></div>',m=getCalEntry(a.name,o),y=a.name&&isAvailableNow(a.name),E=getAEDTDate(),$=m&&m.start&&m.end&&!y&&(()=>{const f=E.getHours()*60+E.getMinutes(),[h,C]=m.end.split(":").map(Number),[b,S]=m.start.split(":").map(Number);return h*60+C>b*60+S&&f>=h*60+C})(),T=a.name?getAvailCountdown(a.name):null,D=T?' <span style="opacity:.65;font-size:.85em">·</span> '+(T.type==="ends"?t("avail.endsIn"):t("avail.startsIn")).replace("{t}",T.str):"",A=y?`<div class="card-avail card-avail-live"><span class="avail-now-dot"></span><span>${t("avail.now")} (${fmtTime12(m.start)} - ${fmtTime12(m.end)})${D}</span></div>`:!$&&m&&m.start&&m.end?`<div class="card-avail">${t("avail.laterToday")} (${fmtTime12(m.start)} - ${fmtTime12(m.end)})${D}</div>`:"";let w="";if(!A&&a.name){const h=getWeekDates().find(C=>C>o&&(getCalEntry(a.name,C)||{}).start);if(h){const C=dispDate(h).day,b=getCalEntry(a.name,h),S=b&&b.start&&b.end?` (${fmtTime12(b.start)} - ${fmtTime12(b.end)})`:"",x=H=>{const N=Math.floor(H/1440),F=Math.floor(H%1440/60),B=H%60;return N>0?`${N}d ${F}h`:F>0?`${F}h ${B}m`:`${B}m`},k=Math.round((new Date(h+" 00:00")-new Date(o+" 00:00"))/864e5),M=E.getHours()*60+E.getMinutes(),[q,I]=(b&&b.start||"00:00").split(":").map(Number),P=k*1440+q*60+I-M,R=P>0?' <span style="opacity:.65;font-size:.85em">·</span> '+t("avail.startsIn").replace("{t}",x(P)):"";w=`<div class="card-coming">${t("avail.coming")} ${C}${S}${R}</div>`}else{const C=getLastRostered(a.name);if(C){const b=Math.round((new Date(o+" 00:00")-new Date(C+" 00:00"))/864e5),S=b===0?"today":b===1?"yesterday":b+" days ago";w=`<div class="card-last-seen">${t("avail.lastSeen")} ${S}</div>`}}}const g=a.name?cardFavBtn(a.name):"",L=a.name?cardCompareBtn(a.name):"";return n.innerHTML=`<div class="card-img" style="background:linear-gradient(135deg,rgba(180,74,255,0.06),rgba(255,111,0,0.03))">${p}${g}${L}${v}</div><div class="card-info"><div class="card-name">${a.name||""}</div><div class="card-country">${Array.isArray(a.country)?a.country.join(", "):a.country||""}</div>${a.special?'<div class="card-special">'+a.special+"</div>":""}${cardRatingHtml(a)}${A||w}${isAdmin()&&a.lastModified?`<div style="font-size:10px;color:rgba(255,255,255,0.28);letter-spacing:1px;margin-top:2px">${daysAgo(a.lastModified)}</div>`:""}<div class="card-hover-line"></div></div>`,n.onclick=f=>{f.target.closest(".card-action-btn")||f.target.closest(".card-fav")||f.target.closest(".card-compare")||(_savedScrollY=window.scrollY,sessionStorage.setItem("ginza_scroll",window.scrollY),profileReturnPage="listPage",showProfile(s))},isAdmin()&&(n.querySelector(".hide-toggle").onclick=async f=>{f.stopPropagation(),a.hidden=!a.hidden,await saveData()&&(renderGrid(),renderRoster(),renderHome(),showToast(a.hidden?t("ui.girlHidden"):t("ui.girlVisible")))},n.querySelector(".edit").onclick=f=>{f.stopPropagation(),openForm(s)},n.querySelector(".delete").onclick=f=>{f.stopPropagation(),openDelete(s)}),n.addEventListener("mouseenter",()=>{clearTimeout(c),c=setTimeout(()=>{const f=document.getElementById("cardHoverPreview");if(!f)return;const h=n.querySelector(".card-avail,.card-coming,.card-last-seen"),C=h?h.innerHTML:"",b=h?h.classList.contains("card-avail-live")?"chp-avail chp-avail-live":h.classList.contains("card-coming")?"chp-avail chp-avail-coming":h.classList.contains("card-last-seen")?"chp-avail chp-avail-last":"chp-avail":"chp-avail";f.innerHTML=`<div class="chp-name">${a.name||""}</div><div class="chp-country">${Array.isArray(a.country)?a.country.join(", "):a.country||""}</div>${a.special?'<div class="chp-special">'+a.special+"</div>":""}${cardRatingHtml(a)?'<div class="chp-rating">'+cardRatingHtml(a)+"</div>":""}${C?'<div class="'+b+'">'+C+"</div>":""}<div class="chp-stats"><div class="chp-row"><span>${t("field.age")}</span><span>${a.age||"—"}</span></div><div class="chp-row"><span>${t("field.body")}</span><span>${a.body||"—"}</span></div><div class="chp-row"><span>${t("field.height")}</span><span>${a.height?a.height+" cm":"—"}</span></div><div class="chp-row"><span>${t("field.cup")}</span><span>${a.cup||"—"}</span></div><div class="chp-divider"></div><div class="chp-row"><span>${t("field.rates30")}</span><span>${a.val1||"—"}</span></div><div class="chp-row"><span>${t("field.rates45")}</span><span>${a.val2||"—"}</span></div><div class="chp-row"><span>${t("field.rates60")}</span><span>${a.val3||"—"}</span></div><div class="chp-row"><span>${t("field.experience")}</span><span>${a.exp||"—"}</span></div></div>`,f.classList.add("visible")},180)}),n.addEventListener("mouseleave",()=>{clearTimeout(c),document.getElementById("cardHoverPreview")?.classList.remove("visible")}),n.addEventListener("mousemove",f=>{const h=document.getElementById("cardHoverPreview");if(!h||!h.classList.contains("visible"))return;const C=window.innerWidth,b=window.innerHeight,S=h.offsetWidth||220,x=h.offsetHeight||280;let k=f.clientX+16,M=f.clientY+16;k+S>C-8&&(k=f.clientX-S-12),M+x>b-8&&(M=f.clientY-x-12),h.style.left=k+"px",h.style.top=M+"px"}),n});d&&grid.appendChild(d)}),bindCardFavs(grid),bindCardCompare(grid),observeLazy(grid),observeEntrance(grid)})}function hasGirlsOnDate(r){return girls.some(o=>{const c=getCalEntry(o.name,r);return c&&c.start&&c.end})}function renderRosterFilters(){const r=document.getElementById("rosterFilterBar");r.innerHTML="";const o=getWeekDates(),c=o[0];rosterDateFilter||(rosterDateFilter=c);const i=o.filter(a=>hasGirlsOnDate(a));i.length&&!i.includes(rosterDateFilter)&&(rosterDateFilter=i[0]),i.length||(rosterDateFilter=null),i.forEach(a=>{const e=dispDate(a),d=document.createElement("button");d.className="filter-btn"+(a===rosterDateFilter?" date-active":""),d.textContent=a===c?t("ui.today"):e.day+" "+e.date,d.onclick=()=>{rosterDateFilter=a,rosterAvailFilter=null,renderRosterFilters(),renderRosterGrid()},r.appendChild(d)}),renderAvailNowBar()}function renderRosterGrid(){safeRender("Roster Grid",()=>{const r=document.getElementById("rosterGrid");if(r.innerHTML="",!rosterDateFilter){r.innerHTML=`<div class="empty-msg">${t("ui.noGirlsWeek")}</div>`;return}const o=fmtDate(getAEDTDate()),c=rosterDateFilter;let i=[...girls].filter(e=>{const d=getCalEntry(e.name,c);return d&&d.start&&d.end});if(isAdmin()||(i=i.filter(e=>!e.hidden)),i=applySharedFilters(i),loggedIn||(i=i.filter(e=>e.name&&String(e.name).trim().length>0)),c===o&&rosterAvailFilter){const e=getAEDTDate(),d=e.getHours()*60+e.getMinutes();rosterAvailFilter==="now"?i=i.filter(s=>s.name&&isAvailableNow(s.name)):rosterAvailFilter==="later"?i=i.filter(s=>{if(!s.name||isAvailableNow(s.name))return!1;const n=getCalEntry(s.name,o);if(!n||!n.start||!n.end)return!1;const[l,u]=n.start.split(":").map(Number),v=l*60+u,[p,m]=n.end.split(":").map(Number);return p*60+m<=v,d<v}):rosterAvailFilter==="finished"&&(i=i.filter(s=>{const n=getCalEntry(s.name,o);if(!n||!n.start||!n.end)return!1;const[l,u]=n.start.split(":").map(Number),[v,p]=n.end.split(":").map(Number),m=l*60+u,y=v*60+p;return y<=m?!1:d>=y&&!isAvailableNow(s.name)}))}if(applySortOrder(i),!i.length){r.innerHTML=`<div class="empty-msg">${t("ui.noGirlsDate")}</div>`;return}let a;i.forEach((e,d)=>{const s=safeCardRender(e,d,()=>{const n=girls.indexOf(e),l=document.createElement("div");l.className="girl-card";const u=e.photos&&e.photos.length?lazyThumb(e.photos[0],"card-thumb",e.name):'<div class="silhouette"></div>',v=c===o,p=getCalEntry(e.name,c),m=v&&e.name&&isAvailableNow(e.name),y=getAEDTDate(),E=v&&p&&p.start&&p.end&&!m&&(()=>{const w=y.getHours()*60+y.getMinutes(),[g,L]=p.end.split(":").map(Number),[f,h]=p.start.split(":").map(Number);return g*60+L>f*60+h&&w>=g*60+L})(),$=p&&p.start&&p.end?" ("+fmtTime12(p.start)+" - "+fmtTime12(p.end)+")":"",T=m?`<div class="card-avail card-avail-live"><span class="avail-now-dot"></span><span>${t("avail.now")}${$}</span></div>`:E?`<div class="card-avail card-avail-finished">${t("avail.finished")}</div>`:v?`<div class="card-avail">${t("avail.laterToday")}${$}</div>`:`<div class="card-avail" style="color:var(--accent)">${$.trim()}</div>`,D=e.name?cardFavBtn(e.name):"",A=e.name?cardCompareBtn(e.name):"";return l.innerHTML=`<div class="card-img" style="background:linear-gradient(135deg,rgba(180,74,255,0.06),rgba(255,111,0,0.03))">${u}${D}${A}</div><div class="card-info"><div class="card-name">${e.name||""}</div><div class="card-country">${Array.isArray(e.country)?e.country.join(", "):e.country||""}</div>${e.special?'<div class="card-special">'+e.special+"</div>":""}${cardRatingHtml(e)}${T}<div class="card-hover-line"></div></div>`,l.onclick=w=>{w.target.closest(".card-fav")||w.target.closest(".card-compare")||(_savedScrollY=window.scrollY,sessionStorage.setItem("ginza_scroll",window.scrollY),profileReturnPage="rosterPage",showProfile(n))},l.addEventListener("mouseenter",()=>{clearTimeout(a),a=setTimeout(()=>{const w=document.getElementById("cardHoverPreview");if(!w)return;const g=l.querySelector(".card-avail,.card-coming,.card-last-seen"),L=g?g.innerHTML:"",f=g?g.classList.contains("card-avail-live")?"chp-avail chp-avail-live":g.classList.contains("card-coming")?"chp-avail chp-avail-coming":g.classList.contains("card-last-seen")?"chp-avail chp-avail-last":"chp-avail":"chp-avail";w.innerHTML=`<div class="chp-name">${e.name||""}</div><div class="chp-country">${Array.isArray(e.country)?e.country.join(", "):e.country||""}</div>${e.special?'<div class="chp-special">'+e.special+"</div>":""}${cardRatingHtml(e)?'<div class="chp-rating">'+cardRatingHtml(e)+"</div>":""}${L?'<div class="'+f+'">'+L+"</div>":""}<div class="chp-stats"><div class="chp-row"><span>${t("field.age")}</span><span>${e.age||"—"}</span></div><div class="chp-row"><span>${t("field.body")}</span><span>${e.body||"—"}</span></div><div class="chp-row"><span>${t("field.height")}</span><span>${e.height?e.height+" cm":"—"}</span></div><div class="chp-row"><span>${t("field.cup")}</span><span>${e.cup||"—"}</span></div><div class="chp-divider"></div><div class="chp-row"><span>${t("field.rates30")}</span><span>${e.val1||"—"}</span></div><div class="chp-row"><span>${t("field.rates45")}</span><span>${e.val2||"—"}</span></div><div class="chp-row"><span>${t("field.rates60")}</span><span>${e.val3||"—"}</span></div><div class="chp-row"><span>${t("field.experience")}</span><span>${e.exp||"—"}</span></div></div>`,w.classList.add("visible")},180)}),l.addEventListener("mouseleave",()=>{clearTimeout(a),document.getElementById("cardHoverPreview")?.classList.remove("visible")}),l.addEventListener("mousemove",w=>{const g=document.getElementById("cardHoverPreview");if(!g||!g.classList.contains("visible"))return;const L=window.innerWidth,f=window.innerHeight,h=g.offsetWidth||220,C=g.offsetHeight||280;let b=w.clientX+16,S=w.clientY+16;b+h>L-8&&(b=w.clientX-h-12),S+C>f-8&&(S=w.clientY-C-12),g.style.left=b+"px",g.style.top=S+"px"}),l});s&&r.appendChild(s)}),bindCardFavs(r),bindCardCompare(r),observeLazy(r),observeEntrance(r),renderAvailNowBar()})}function renderRoster(){renderRosterFilters(),renderRosterGrid()}function renderFavoritesGrid(){safeRender("Favorites Grid",()=>{const r=document.getElementById("favoritesGrid");r.innerHTML="";const o=getFavorites(),c=fmtDate(getAEDTDate());let i=girls.filter(e=>e.name&&o.includes(e.name));if(isAdmin()||(i=i.filter(e=>!e.hidden)),applySortOrder(i),!i.length){r.innerHTML=`<div class="fav-empty"><div class="fav-empty-icon">&hearts;</div><div class="fav-empty-text">${t("ui.favEmpty")}</div><button class="empty-state-cta" onclick="showPage('listPage');Router.push('/girls')">${t("ui.favBrowse")}</button></div>`;return}let a;i.forEach((e,d)=>{const s=safeCardRender(e,d,()=>{const n=girls.indexOf(e),l=document.createElement("div");l.className="girl-card";const u=e.photos&&e.photos.length?lazyThumb(e.photos[0],"card-thumb",e.name):'<div class="silhouette"></div>',v=getCalEntry(e.name,c),m=e.name&&isAvailableNow(e.name)?`<div class="card-avail card-avail-live"><span class="avail-now-dot"></span><span>${t("avail.now")} (${fmtTime12(v.start)} - ${fmtTime12(v.end)})</span></div>`:v&&v.start&&v.end?`<div class="card-avail">${t("avail.laterToday")} (${fmtTime12(v.start)} - ${fmtTime12(v.end)})</div>`:"",y=cardFavBtn(e.name),E=cardCompareBtn(e.name);return l.innerHTML=`<div class="card-img" style="background:linear-gradient(135deg,rgba(180,74,255,0.06),rgba(255,111,0,0.03))">${u}${y}${E}</div><div class="card-info"><div class="card-name">${e.name||""}</div><div class="card-country">${Array.isArray(e.country)?e.country.join(", "):e.country||""}</div>${e.special?'<div class="card-special">'+e.special+"</div>":""}${cardRatingHtml(e)}${m}<div class="card-hover-line"></div></div>`,l.onclick=$=>{$.target.closest(".card-fav")||$.target.closest(".card-compare")||(_savedScrollY=window.scrollY,sessionStorage.setItem("ginza_scroll",window.scrollY),profileReturnPage="favoritesPage",showProfile(n))},l.addEventListener("mouseenter",()=>{clearTimeout(a),a=setTimeout(()=>{const $=document.getElementById("cardHoverPreview");if(!$)return;const T=l.querySelector(".card-avail,.card-coming,.card-last-seen"),D=T?T.innerHTML:"",A=T?T.classList.contains("card-avail-live")?"chp-avail chp-avail-live":T.classList.contains("card-coming")?"chp-avail chp-avail-coming":T.classList.contains("card-last-seen")?"chp-avail chp-avail-last":"chp-avail":"chp-avail";$.innerHTML=`<div class="chp-name">${e.name||""}</div><div class="chp-country">${Array.isArray(e.country)?e.country.join(", "):e.country||""}</div>${e.special?'<div class="chp-special">'+e.special+"</div>":""}${cardRatingHtml(e)?'<div class="chp-rating">'+cardRatingHtml(e)+"</div>":""}${D?'<div class="'+A+'">'+D+"</div>":""}<div class="chp-stats"><div class="chp-row"><span>${t("field.age")}</span><span>${e.age||"—"}</span></div><div class="chp-row"><span>${t("field.body")}</span><span>${e.body||"—"}</span></div><div class="chp-row"><span>${t("field.height")}</span><span>${e.height?e.height+" cm":"—"}</span></div><div class="chp-row"><span>${t("field.cup")}</span><span>${e.cup||"—"}</span></div><div class="chp-divider"></div><div class="chp-row"><span>${t("field.rates30")}</span><span>${e.val1||"—"}</span></div><div class="chp-row"><span>${t("field.rates45")}</span><span>${e.val2||"—"}</span></div><div class="chp-row"><span>${t("field.rates60")}</span><span>${e.val3||"—"}</span></div><div class="chp-row"><span>${t("field.experience")}</span><span>${e.exp||"—"}</span></div></div>`,$.classList.add("visible")},180)}),l.addEventListener("mouseleave",()=>{clearTimeout(a),document.getElementById("cardHoverPreview")?.classList.remove("visible")}),l.addEventListener("mousemove",$=>{const T=document.getElementById("cardHoverPreview");if(!T||!T.classList.contains("visible"))return;const D=window.innerWidth,A=window.innerHeight,w=T.offsetWidth||220,g=T.offsetHeight||280;let L=$.clientX+16,f=$.clientY+16;L+w>D-8&&(L=$.clientX-w-12),f+g>A-8&&(f=$.clientY-g-12),T.style.left=L+"px",T.style.top=f+"px"}),l});s&&r.appendChild(s)}),r.querySelectorAll(".card-fav").forEach(e=>{e.onclick=d=>{d.stopPropagation();const s=e.dataset.favName;s&&(toggleFavorite(s),updateFavBadge(),renderFavoritesGrid())}}),bindCardCompare(r),observeLazy(r),observeEntrance(r)})}function renderValueTable(){safeRender("Value Table",()=>{const r=document.getElementById("valueTable"),o=[{label:"30 mins",key:"val1"},{label:"45 mins",key:"val2"},{label:"60 mins",key:"val3"}];let c=`<thead><tr><th style="text-align:left">${t("table.rates")}</th><th style="text-align:left">${t("table.priceRange")}</th></tr></thead><tbody>`;o.forEach(i=>{const a=[];girls.forEach(d=>{const s=d[i.key];if(!s)return;String(s).replace(/[\$,\s]/g,"").split(/[-–—~]+/).forEach(u=>{const v=parseFloat(u);!isNaN(v)&&v>0&&a.push(v)})});let e="—";if(a.length){const d=Math.min(...a),s=Math.max(...a);e=d===s?"$"+d:"$"+d+" – $"+s}c+=`<tr><td style="text-align:left;font-family:'Orbitron',sans-serif;font-size:13px;letter-spacing:2px;color:#fff;text-transform:uppercase">${i.label}</td><td style="text-align:left;font-family:'Orbitron',sans-serif;font-size:16px;letter-spacing:2px;color:var(--accent)">${e}</td></tr>`}),c+="</tbody>",r.innerHTML=c})}let calMobileDay=0;function updateMobileCalView(r,o){const c=String(calMobileDay+1);r.querySelectorAll("[data-cal-col]").forEach(a=>{a.classList.toggle("cal-col-active",a.dataset.calCol===c)});const i=document.getElementById("calMobileDayLabel");if(i){const a=dispDate(o[calMobileDay]);i.textContent=(calMobileDay===0?"Today · ":"")+a.day+" "+a.date}}function generateTimeOptions(){const r=['<option value="">--:--</option>'];for(let o=0;o<24;o++)for(let c=0;c<60;c+=30){const i=String(o).padStart(2,"0")+":"+String(c).padStart(2,"0"),a=o===0?12:o>12?o-12:o;r.push(`<option value="${i}">${a}:${String(c).padStart(2,"0")} ${o<12?"AM":"PM"}</option>`)}return r.join("")}function renderCalendar(){safeRender("Calendar",()=>{const r=document.getElementById("calFilterBar");if(r.innerHTML="",isAdmin()){const s=document.createElement("button");s.className="add-btn",s.innerHTML="&#x2398; Copy Day",s.onclick=()=>openCopyDayModal(),r.appendChild(s)}const o=applySharedFilters([...girls].filter(s=>s.name&&String(s.name).trim().length>0)).sort((s,n)=>(s.name||"").trim().toLowerCase().localeCompare((n.name||"").trim().toLowerCase())),c=document.getElementById("calTable"),i=getWeekDates(),a=i[0],e=generateTimeOptions();let d=`<thead><tr><th>${t("cal.profile")}</th>`;i.forEach((s,n)=>{const l=dispDate(s);d+=`<th class="${n===0?"cal-today":""}" data-cal-col="${n+1}">${l.date}<span class="cal-day-name">${l.day}${n===0?` (${t("ui.today")})`:""}</span></th>`}),d+="</tr></thead><tbody>",o.forEach(s=>{const n=girls.indexOf(s),l=s.photos&&s.photos.length?lazyCalAvatar(s.photos[0],s.name):`<span class="cal-letter">${s.name.charAt(0)}</span>`,u=isAdmin()?`<div class="cal-bulk-actions"><button class="cal-bulk-btn cal-bulk-all" data-bulk-name="${s.name}" title="Mark available all week">${t("cal.allWeek")}</button><button class="cal-bulk-btn cal-bulk-clear" data-bulk-name="${s.name}" title="Clear entire week">${t("cal.clear")}</button></div>`:"";d+=`<tr><td><div class="cal-profile" data-idx="${n}"><div class="cal-avatar">${l}</div><div><div class="cal-name">${s.name}</div>${u}</div></div></td>`,i.forEach((v,p)=>{const m=getCalEntry(s.name,v),y=m?"checked":"",E=!!m;d+=`<td class="${p===0?"cal-today":""}" data-cal-col="${p+1}"><div class="cal-cell-inner"><input type="checkbox" class="cal-check" data-name="${s.name}" data-date="${v}" ${y}><div class="cal-time-wrap" style="display:${E?"flex":"none"}" data-time-name="${s.name}" data-time-date="${v}"><div class="cal-time-row"><label>Start</label><select class="cal-time-input" data-field="start" data-tname="${s.name}" data-tdate="${v}">${e}</select></div><div class="cal-time-row"><label>End</label><select class="cal-time-input" data-field="end" data-tname="${s.name}" data-tdate="${v}">${e}</select></div><div class="cal-time-warn" data-warn-name="${s.name}" data-warn-date="${v}"></div></div></div></td>`}),d+="</tr>"}),d+="</tbody>",c.innerHTML=d,observeLazy(c),observeCalEntrance(c);{const s=document.getElementById("calMobileNav");if(s){s.innerHTML='<div class="cal-mobile-nav"><button class="cal-mobile-btn" id="calMobilePrev">&#8249;</button><div class="cal-mobile-label" id="calMobileDayLabel"></div><button class="cal-mobile-btn" id="calMobileNext">&#8250;</button></div>';const n=document.getElementById("calMobilePrev"),l=document.getElementById("calMobileNext");n&&(n.onclick=()=>{calMobileDay>0&&(calMobileDay--,updateMobileCalView(c,i))}),l&&(l.onclick=()=>{calMobileDay<6&&(calMobileDay++,updateMobileCalView(c,i))}),updateMobileCalView(c,i)}}o.forEach(s=>{getWeekDates().forEach(n=>{const l=getCalEntry(s.name,n);if(l){const u=c.querySelector(`select[data-field="start"][data-tname="${s.name}"][data-tdate="${n}"]`),v=c.querySelector(`select[data-field="end"][data-tname="${s.name}"][data-tdate="${n}"]`);if(u&&l.start&&(u.value=l.start),v&&l.end&&(v.value=l.end),!l.start||!l.end){calPending[s.name]||(calPending[s.name]={}),calPending[s.name][n]=!0;const p=c.querySelector(`[data-warn-name="${s.name}"][data-warn-date="${n}"]`);p&&(p.textContent="Times required")}}})}),c.querySelectorAll(".cal-profile").forEach(s=>{s.onclick=n=>{n.target.closest(".cal-bulk-btn")||(profileReturnPage="calendarPage",showProfile(parseInt(s.dataset.idx)))}}),isAdmin()&&(c.querySelectorAll(".cal-bulk-all").forEach(s=>{s.onclick=n=>{n.stopPropagation();const l=s.dataset.bulkName;openBulkTimeModal(l)}}),c.querySelectorAll(".cal-bulk-clear").forEach(s=>{s.onclick=n=>{n.stopPropagation();const l=s.dataset.bulkName,u=getWeekDates();let v=0;u.forEach(p=>{calData[l]&&calData[l][p]&&(delete calData[l][p],v++),calPending[l]&&delete calPending[l][p]}),v>0&&(queueCalSave(null,100),renderCalendar(),renderRoster(),renderGrid(),renderHome(),showToast(l+" cleared for the week"))}})),c.querySelectorAll(".cal-check").forEach(s=>{s.onchange=async function(){const n=this.dataset.name,l=this.dataset.date,u=c.querySelector(`[data-time-name="${n}"][data-time-date="${l}"]`);if(this.checked){calData[n]||(calData[n]={});const v=findExistingTimes(n,l);if(v){const p=await showCopyTimePrompt(n,v.date,v.start,v.end);if(p==="cancel"){this.checked=!1,calData[n]&&delete calData[n][l],calPending[n]&&delete calPending[n][l],u&&(u.style.display="none");return}if(p==="copy"){if(calData[n][l]={start:v.start,end:v.end},u){u.style.display="flex";const y=c.querySelector(`select[data-field="start"][data-tname="${n}"][data-tdate="${l}"]`),E=c.querySelector(`select[data-field="end"][data-tname="${n}"][data-tdate="${l}"]`);y&&(y.value=v.start),E&&(E.value=v.end);const $=c.querySelector(`[data-warn-name="${n}"][data-warn-date="${l}"]`);$&&($.textContent="")}const m=this.closest("td");queueCalSave(m,100),showToast("Times copied");return}else{if(calData[n][l]={start:"",end:""},calPending[n]||(calPending[n]={}),calPending[n][l]=!0,u){u.style.display="flex";const m=c.querySelector(`[data-warn-name="${n}"][data-warn-date="${l}"]`);m&&(m.textContent="Times required")}return}}if(calData[n][l]={start:"",end:""},calPending[n]||(calPending[n]={}),calPending[n][l]=!0,u){u.style.display="flex";const p=c.querySelector(`[data-warn-name="${n}"][data-warn-date="${l}"]`);p&&(p.textContent="Times required")}}else{if(calData[n]&&delete calData[n][l],calPending[n]&&delete calPending[n][l],u){u.style.display="none";const v=c.querySelector(`select[data-field="start"][data-tname="${n}"][data-tdate="${l}"]`),p=c.querySelector(`select[data-field="end"][data-tname="${n}"][data-tdate="${ds}"]`);v&&(v.value=""),p&&(p.value="");const m=c.querySelector(`[data-warn-name="${n}"][data-warn-date="${l}"]`);m&&(m.textContent="")}queueCalSave(this.closest("td"))}}}),c.querySelectorAll(".cal-time-input").forEach(s=>{s.onchange=function(){const n=this.dataset.tname,l=this.dataset.tdate,u=this.dataset.field;if(!calData[n]||!calData[n][l])return;typeof calData[n][l]!="object"&&(calData[n][l]={start:"",end:""}),calData[n][l][u]=this.value;const v=calData[n][l],p=c.querySelector(`[data-warn-name="${n}"][data-warn-date="${l}"]`);v.start&&v.end?(this.classList.remove("invalid"),calPending[n]&&delete calPending[n][l],p&&(p.textContent=""),queueCalSave(this.closest("td")),showToast("Schedule saved")):(this.classList.remove("invalid"),p&&(p.textContent="Times required"),calPending[n]||(calPending[n]={}),calPending[n][l]=!0)}})})}
